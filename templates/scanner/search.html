{% extends 'base.html' %}
{% load static %}

{% block title %}Search Products - Food Scanner{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Modern Search Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3" style="font-family: 'Manrope', sans-serif;">
                    <i class="bi bi-search me-3 text-primary"></i>Search Products
                </h1>
                <p class="fs-5 text-muted">Find products by name, brand, or barcode</p>
            </div>

            <!-- Enhanced Search Card -->
            <div class="card border-0 shadow-sm mb-5">
                <div class="card-body p-4">
                    <!-- Search Tabs -->
                    <ul class="nav nav-pills nav-fill mb-4" id="searchTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="text-search-tab" data-bs-toggle="pill" 
                                    data-bs-target="#text-search" type="button" role="tab">
                                <i class="bi bi-search me-2"></i>Text Search
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="barcode-search-tab" data-bs-toggle="pill" 
                                    data-bs-target="#barcode-search" type="button" role="tab">
                                <i class="bi bi-upc-scan me-2"></i>Barcode Search
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="searchTabContent">
                        <!-- Text Search Tab -->
                        <div class="tab-pane fade show active" id="text-search" role="tabpanel">
                            <form method="get" class="mb-3">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-light border-end-0">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" name="q" 
                                           value="{{ query }}" 
                                           placeholder="Search by product name, brand, or category..."
                                           autocomplete="off">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="bi bi-search me-1"></i>Search
                                    </button>
                                </div>
                            </form>
                            <div class="d-flex flex-wrap gap-2">
                                <small class="text-muted">Popular searches:</small>
                                <a href="?q=organic" class="badge bg-light text-dark text-decoration-none">Organic</a>
                                <a href="?q=chocolate" class="badge bg-light text-dark text-decoration-none">Chocolate</a>
                                <a href="?q=milk" class="badge bg-light text-dark text-decoration-none">Milk</a>
                                <a href="?q=bread" class="badge bg-light text-dark text-decoration-none">Bread</a>
                            </div>
                        </div>

                        <!-- Barcode Search Tab -->
                        <div class="tab-pane fade" id="barcode-search" role="tabpanel">
                            <form method="post" action="{% url 'scanner:manual_entry' %}" id="barcodeSearchForm">
                                {% csrf_token %}
                                <div class="input-group input-group-lg mb-3">
                                    <span class="input-group-text bg-light border-end-0">
                                        <i class="bi bi-upc-scan text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" name="barcode" 
                                           id="barcodeInput"
                                           placeholder="Enter barcode number (8-14 digits)..."
                                           pattern="[0-9]{8,14}"
                                           value="{{ barcode_error|default:'' }}"
                                           autocomplete="off">
                                    <button type="submit" class="btn btn-primary px-4" id="barcodeSearchBtn">
                                        <span class="btn-text">
                                            <i class="bi bi-search me-1"></i>Find Product
                                        </span>
                                        <span class="btn-loading d-none">
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                            Searching...
                                        </span>
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Enter the barcode number found on the product packaging
                                        </small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <small class="text-muted">
                                            Supported formats: EAN-13, UPC-A, EAN-8, ITF-14
                                        </small>
                                    </div>
                                </div>
                            </form>

                            <!-- Show barcode not found message if applicable -->
                            {% if barcode_not_found %}
                            <div class="alert alert-warning border-0 mt-3">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-3 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-semibold mb-2">Product Not Found</h6>
                                        <p class="mb-3">We couldn't find a product with barcode <code>{{ barcode_not_found }}</code> in our database or external sources.</p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <small class="text-muted me-3">You can check these sources:</small>
                                            {% for url in suggest_urls %}
                                            <a href="{{ url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-box-arrow-up-right me-1"></i>Source {{ forloop.counter }}
                                            </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Barcode Examples -->
                            <div class="mt-4 p-3 bg-light bg-opacity-50 rounded-3">
                                <h6 class="fw-semibold mb-3">
                                    <i class="bi bi-lightbulb me-2 text-warning"></i>Barcode Examples
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2">EAN-13</span>
                                            <code class="text-muted cursor-pointer" onclick="fillBarcode(this)">1234567890123</code>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">UPC-A</span>
                                            <code class="text-muted cursor-pointer" onclick="fillBarcode(this)">123456789012</code>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-success me-2">EAN-8</span>
                                            <code class="text-muted cursor-pointer" onclick="fillBarcode(this)">12345678</code>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-warning text-dark me-2">ITF-14</span>
                                            <code class="text-muted cursor-pointer" onclick="fillBarcode(this)">12345678901234</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            {% if query %}
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fw-semibold mb-1">Search Results</h4>
                        <p class="text-muted mb-0">
                            Found {{ results_count }} product{{ results_count|pluralize }} for "{{ query }}"
                        </p>
                    </div>
                    {% if results_count > 0 %}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel me-1"></i>Sort
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?q={{ query }}&sort=name">Name A-Z</a></li>
                            <li><a class="dropdown-item" href="?q={{ query }}&sort=brand">Brand</a></li>
                            <li><a class="dropdown-item" href="?q={{ query }}&sort=recent">Most Recent</a></li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if page_obj %}
            <div class="row g-4">
                {% for product in page_obj %}
                <div class="col-lg-6">
                    <div class="card product-card border-0 shadow-sm h-100 interactive-card">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-start">
                                <div class="product-image me-3">
                                    {% if product.image_url %}
                                        <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                                             class="rounded-3" width="80" height="80" style="object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded-3 d-flex align-items-center justify-content-center border" 
                                             style="width: 80px; height: 80px;">
                                            <i class="bi bi-image text-muted fs-3"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="card-title mb-2 fw-semibold">
                                        <a href="{% url 'scanner:product_detail' product.barcode %}" 
                                           class="text-decoration-none text-dark">
                                            {{ product.name|truncatechars:60 }}
                                        </a>
                                    </h5>
                                    <div class="mb-2">
                                        {% if product.brand %}
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary me-2">
                                            <i class="bi bi-building me-1"></i>{{ product.brand }}
                                        </span>
                                        {% endif %}
                                        {% if product.category %}
                                        <span class="badge bg-primary bg-opacity-10 text-primary me-2">
                                            <i class="bi bi-tag me-1"></i>{{ product.category|truncatechars:20 }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="bi bi-upc-scan me-1"></i>{{ product.barcode }}
                                        </small>
                                        {% if product.health_score %}
                                        <div class="health-score-mini 
                                            {% if product.health_score >= 80 %}bg-success
                                            {% elif product.health_score >= 60 %}bg-info
                                            {% elif product.health_score >= 40 %}bg-warning
                                            {% else %}bg-danger{% endif %} text-white">
                                            {{ product.health_score }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if product.ecoscore %}
                                    <div class="mt-2">
                                        <span class="badge bg-success bg-opacity-10 text-success">
                                            <i class="bi bi-leaf me-1"></i>Eco-Score {{ product.ecoscore|upper }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Search results pagination" class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&page=1">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&page={{ page_obj.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?q={{ query }}&page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&page={{ page_obj.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&page={{ page_obj.paginator.num_pages }}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% elif query %}
            <!-- No Results Found -->
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted mb-4"></i>
                <h4 class="fw-semibold mb-3">No products found</h4>
                <p class="text-muted mb-4">
                    We couldn't find any products matching "{{ query }}". 
                    Try different keywords or check the spelling.
                </p>
                <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
                    <a href="{% url 'scanner:scan' %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-camera me-2"></i>Scan a Product
                    </a>
                    <button class="btn btn-outline-primary btn-lg" onclick="clearSearch()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Try New Search
                    </button>
                </div>
                
                <!-- Search Tips -->
                <div class="mt-5 p-4 bg-light bg-opacity-50 rounded-3 text-start">
                    <h6 class="fw-semibold mb-3">
                        <i class="bi bi-lightbulb me-2 text-warning"></i>Search Tips
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Try shorter, more general terms
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Search by brand name only
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Use the barcode search tab
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Check for typos
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Initial Search State -->
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted mb-4"></i>
                <h4 class="fw-semibold mb-3">Discover Products</h4>
                <p class="text-muted mb-4">
                    Search our database of thousands of products or scan a barcode to get started.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-4 bg-primary bg-opacity-10 rounded-3 text-center">
                                    <i class="bi bi-search fs-1 text-primary mb-3"></i>
                                    <h6 class="fw-semibold">Text Search</h6>
                                    <p class="text-muted small mb-0">Find products by name, brand, or category</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-4 bg-success bg-opacity-10 rounded-3 text-center">
                                    <i class="bi bi-upc-scan fs-1 text-success mb-3"></i>
                                    <h6 class="fw-semibold">Barcode Search</h6>
                                    <p class="text-muted small mb-0">Enter barcode numbers directly</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Enhanced product card styling */
.product-card {
    transition: all var(--transition-normal);
    cursor: pointer;
}

.product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

/* Health score mini indicator */
.health-score-mini {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
}

/* Enhanced nav pills */
.nav-pills .nav-link {
    border-radius: var(--border-radius-sm);
    font-weight: 500;
    transition: all var(--transition-fast);
    color: var(--text-secondary);
}

.nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: white;
}

.nav-pills .nav-link:hover:not(.active) {
    background-color: var(--bg-secondary);
    color: var(--primary-color);
}

/* Enhanced input styling */
.input-group-text {
    background-color: var(--bg-secondary);
    border-color: var(--border-color);
}

.form-control {
    border-color: var(--border-color);
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
}

/* Badge enhancements */
.badge {
    font-weight: 500;
    padding: 0.5rem 0.75rem;
}

/* Pagination styling */
.pagination .page-link {
    color: var(--primary-color);
    border-color: var(--border-color);
    padding: 0.75rem 1rem;
}

.pagination .page-link:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
}

.pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* Loading state */
.btn-loading {
    pointer-events: none;
}

/* Barcode input validation */
.form-control:invalid {
    border-color: var(--health-poor);
}

.form-control:valid {
    border-color: var(--health-excellent);
}

/* Tab content styling */
.tab-content {
    min-height: 200px;
}

/* Interactive elements */
.interactive-card {
    cursor: pointer;
}

.interactive-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* Cursor pointer for clickable elements */
.cursor-pointer {
    cursor: pointer;
}

.cursor-pointer:hover {
    color: var(--primary-color) !important;
    text-decoration: underline;
}

/* Enhanced form validation styling */
.form-control.is-valid {
    border-color: var(--health-excellent);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310b981' d='m2.3 6.73.94-.94 1.44 1.44L7.4 4.5l.94.94L4.66 9.17z'/%3e%3c/svg%3e");
}

.form-control.is-invalid {
    border-color: var(--health-poor);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23ef4444'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.5 5.5 1 1m0-1-1 1'/%3e%3c/svg%3e");
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .health-score-mini {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
    }
    
    .product-image img,
    .product-image div {
        width: 60px !important;
        height: 60px !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced barcode form handling
    const barcodeForm = document.getElementById('barcodeSearchForm');
    const barcodeInput = document.getElementById('barcodeInput');
    const barcodeBtn = document.getElementById('barcodeSearchBtn');
    const btnText = barcodeBtn.querySelector('.btn-text');
    const btnLoading = barcodeBtn.querySelector('.btn-loading');
    
    // Real-time barcode validation
    barcodeInput.addEventListener('input', function() {
        const value = this.value.replace(/\D/g, ''); // Remove non-digits
        this.value = value;
        
        // Visual feedback
        if (value.length >= 8 && value.length <= 14) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            barcodeBtn.disabled = false;
        } else {
            this.classList.remove('is-valid');
            if (value.length > 0) {
                this.classList.add('is-invalid');
            }
            barcodeBtn.disabled = value.length === 0;
        }
    });
    
    // Form submission with loading state
    barcodeForm.addEventListener('submit', function(e) {
        const barcode = barcodeInput.value.trim();
        
        if (!barcode || barcode.length < 8 || barcode.length > 14) {
            e.preventDefault();
            alert('Please enter a valid barcode (8-14 digits)');
            return;
        }
        
        // Show loading state
        barcodeBtn.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
    });
    
    // Auto-focus on tab switch
    document.getElementById('barcode-search-tab').addEventListener('shown.bs.tab', function() {
        barcodeInput.focus();
    });
    
    // Product card click handling
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.tagName !== 'A') {
                const link = this.querySelector('a[href]');
                if (link) {
                    window.location.href = link.href;
                }
            }
        });
    });
    
    // Search suggestions
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !this.value.trim()) {
                e.preventDefault();
                alert('Please enter a search term');
            }
        });
    }
});

// Clear search function
function clearSearch() {
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
    }
}

// Barcode examples click handler
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'CODE') {
        const barcodeInput = document.getElementById('barcodeInput');
        if (barcodeInput) {
            barcodeInput.value = e.target.textContent;
            barcodeInput.dispatchEvent(new Event('input'));
            barcodeInput.focus();
        }
    }
});

// Enhanced search with debouncing for future AJAX implementation
let searchTimeout;
function debounceSearch(func, delay) {
    return function(...args) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(this, args), delay);
    };
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const activeTab = document.querySelector('.nav-link.active');
        if (activeTab && activeTab.id === 'barcode-search-tab') {
            document.getElementById('barcodeInput').focus();
        } else {
            document.querySelector('input[name="q"]').focus();
        }
    }
});

function fillBarcode(element) {
    const barcodeInput = document.getElementById('barcodeInput');
    if (barcodeInput) {
        barcodeInput.value = element.textContent;
        barcodeInput.dispatchEvent(new Event('input'));
        barcodeInput.focus();
        
        // Switch to barcode tab if not already active
        const barcodeTab = document.getElementById('barcode-search-tab');
        if (barcodeTab && !barcodeTab.classList.contains('active')) {
            barcodeTab.click();
        }
    }
}
</script>
{% endblock %}
