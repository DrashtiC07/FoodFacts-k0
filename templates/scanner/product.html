{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - FoodScanner{% endblock %}

{% block extra_css %}
<style>
    .health-score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: white;
        position: relative;
    }
    .health-score-excellent { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .health-score-good { background: linear-gradient(135deg, #84cc16, #65a30d); }
    .health-score-fair { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .health-score-poor { background: linear-gradient(135deg, #ef4444, #dc2626); }
    
    .nutrition-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .dietary-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Product Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'scanner:index' %}">Home</a></li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </nav>
            
            <h1 class="display-6 fw-bold mb-2">{{ product.name }}</h1>
            {% if product.brand %}
            <p class="lead text-muted mb-3">by {{ product.brand }}</p>
            {% endif %}
            
            <div class="d-flex gap-2 mb-3">
                <span class="badge bg-secondary">{{ product.barcode }}</span>
                {% if product.category %}
                <span class="badge bg-info">{{ product.category }}</span>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4 text-md-end">
            {% if user.is_authenticated %}
            <div class="btn-group mb-3" role="group">
                <form method="post" action="{% url 'scanner:toggle_favorite' product.barcode %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}">
                        <i class="bi bi-heart{% if is_favorite %}-fill{% endif %} me-1"></i>
                        {% if is_favorite %}Remove from Favorites{% else %}Add to Favorites{% endif %}
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Product Image & Basic Info -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="img-fluid rounded mb-3" style="max-height: 300px;">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 300px;">
                        <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Health Score -->
                    {% if product.health_score %}
                    <div class="text-center mb-4">
                        <div class="health-score-circle mx-auto mb-2 
                            {% if product.health_score >= 80 %}health-score-excellent
                            {% elif product.health_score >= 60 %}health-score-good
                            {% elif product.health_score >= 40 %}health-score-fair
                            {% else %}health-score-poor{% endif %}">
                            {{ product.health_score }}
                        </div>
                        <h5 class="fw-bold">Health Score</h5>
                        <p class="text-muted small">
                            {% if product.health_score >= 80 %}Excellent choice!
                            {% elif product.health_score >= 60 %}Good option
                            {% elif product.health_score >= 40 %}Fair choice
                            {% else %}Consider alternatives{% endif %}
                        </p>
                    </div>
                    {% endif %}
                    
                    <!-- Eco Score & Nova Group -->
                    <div class="row text-center">
                        {% if product.ecoscore %}
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-success mb-1">{{ product.ecoscore }}</h3>
                                <small class="text-muted">Eco Score</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if product.nova_group %}
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="fw-bold text-info mb-1">{{ product.nova_group }}</h3>
                                <small class="text-muted">NOVA Group</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Detailed Information -->
        <div class="col-lg-8">
            <!-- Dietary Flags -->
            {% if dietary_flags %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-shield-check me-2"></i>Dietary Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for flag in dietary_flags %}
                        <div class="col-md-6">
                            <div class="dietary-badge bg-{{ flag.color }} bg-opacity-10 border border-{{ flag.color }} border-opacity-25 d-flex align-items-center">
                                <span class="me-2">{{ flag.icon }}</span>
                                <span class="text-{{ flag.color }}">{{ flag.label }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Nutrition Facts -->
            {% if nutrition_facts %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Nutrition Facts
                        <small class="text-muted">(per 100g)</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for fact in nutrition_facts %}
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-medium">{{ fact.name }}</span>
                                <span class="text-muted">{{ fact.value }}{{ fact.unit }}</span>
                            </div>
                            {% if fact.percentage %}
                            <div class="nutrition-bar bg-light">
                                <div class="h-100 bg-primary" style="width: {{ fact.percentage }}%"></div>
                            </div>
                            <small class="text-muted">{{ fact.percentage }}% of daily value</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ingredients -->
            {% if product.ingredients %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-list-ul me-2"></i>Ingredients
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ product.ingredients }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Allergens -->
            {% if product.allergens %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="fw-bold mb-0 text-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>Allergen Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for allergen in product.allergens %}
                        <span class="badge bg-warning text-dark">{{ allergen|title }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-star me-2"></i>Reviews
                        {% if product.review_count %}
                        <span class="badge bg-secondary">{{ product.review_count }}</span>
                        {% endif %}
                    </h5>
                    {% if product.average_rating %}
                    <div class="text-warning">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.average_rating %}
                                <i class="bi bi-star-fill"></i>
                            {% else %}
                                <i class="bi bi-star"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="text-muted ms-1">({{ product.average_rating|floatformat:1 }})</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                        {% if not existing_review %}
                        <!-- Add Review Form -->
                        <form method="post" action="{% url 'scanner:submit_review' product.barcode %}" class="mb-4">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Rating</label>
                                <div class="rating-input">
                                    {% for i in "12345" %}
                                    <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" class="d-none">
                                    <label for="star{{ forloop.counter }}" class="text-warning fs-4 cursor-pointer">
                                        <i class="bi bi-star"></i>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="review_text" class="form-label fw-bold">Your Review</label>
                                <textarea class="form-control" id="review_text" name="review_text" rows="3" placeholder="Share your thoughts about this product..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-2"></i>Submit Review
                            </button>
                        </form>
                        {% else %}
                        <!-- Existing Review -->
                        <div class="alert alert-info">
                            <strong>Your Review:</strong>
                            <div class="text-warning mb-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= existing_review.rating %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if existing_review.review_text %}
                            <p class="mb-0">{{ existing_review.review_text }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% else %}
                    <p class="text-muted">
                        <a href="{% url 'accounts:login' %}">Login</a> to write a review.
                    </p>
                    {% endif %}

                    <!-- Display Reviews -->
                    {% for review in product.reviews.all|slice:":5" %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ review.user.username }}</strong>
                                <div class="text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <i class="bi bi-star-fill"></i>
                                        {% else %}
                                            <i class="bi bi-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                        </div>
                        {% if review.review_text %}
                        <p class="mt-2 mb-0">{{ review.review_text }}</p>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-4">No reviews yet. Be the first to review this product!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Rating input functionality
    const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
    const ratingLabels = document.querySelectorAll('.rating-input label');
    
    ratingLabels.forEach((label, index) => {
        label.addEventListener('mouseenter', function() {
            highlightStars(index + 1);
        });
        
        label.addEventListener('click', function() {
            ratingInputs[index].checked = true;
        });
    });
    
    document.querySelector('.rating-input').addEventListener('mouseleave', function() {
        const checkedInput = document.querySelector('.rating-input input[type="radio"]:checked');
        if (checkedInput) {
            highlightStars(parseInt(checkedInput.value));
        } else {
            highlightStars(0);
        }
    });
    
    function highlightStars(count) {
        ratingLabels.forEach((label, index) => {
            const icon = label.querySelector('i');
            if (index < count) {
                icon.className = 'bi bi-star-fill';
            } else {
                icon.className = 'bi bi-star';
            }
        });
    }
});
</script>
{% endblock %}
