{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Food Scanner{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Modern Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item">
                <a href="{% url 'scanner:index' %}" class="text-decoration-none" style="color: var(--primary-color);">
                    <i class="bi bi-house me-1"></i>Home
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'scanner:search' %}" class="text-decoration-none" style="color: var(--primary-color);">Products</a>
            </li>
            <li class="breadcrumb-item active" style="color: var(--text-muted);">{{ product.name|truncatechars:30 }}</li>
        </ol>
    </nav>

    <!-- Product Hero Section -->
    <div class="row mb-5">
        <div class="col-lg-5 mb-4">
            <!-- Product Image Card -->
            <div class="card border-0 shadow-sm sticky-top" style="top: 2rem; background: var(--card-bg); border: 1px solid var(--border-color) !important;">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                             class="img-fluid rounded-3 shadow-sm" 
                             style="max-height: 350px; width: 100%; object-fit: contain;">
                        {% else %}
                        <div class="rounded-3 d-flex align-items-center justify-content-center shadow-sm" 
                             style="height: 350px; background: var(--bg-secondary);">
                            <div class="text-center">
                                <i class="bi bi-image" style="font-size: 4rem; color: var(--text-muted);"></i>
                                <p class="mt-2 mb-0" style="color: var(--text-muted);">No image available</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Health Score Showcase -->
                    {% if product.health_score %}
                    <div class="text-center mb-4">
                        <div class="health-score-circle mx-auto mb-3 
                            {% if product.health_score >= 80 %}health-score-excellent
                            {% elif product.health_score >= 60 %}health-score-good
                            {% elif product.health_score >= 40 %}health-score-fair
                            {% else %}health-score-poor{% endif %}">
                            <div class="text-center">
                                <div class="fs-2 fw-bold">{{ product.health_score }}</div>
                                <small class="opacity-75">/ 100</small>
                            </div>
                        </div>
                        <h5 class="fw-bold mb-2" style="font-family: 'Work Sans', sans-serif; color: var(--text-primary);">Health Score</h5>
                        <p class="mb-0" style="color: var(--text-muted);">
                            {% if product.health_score >= 80 %}
                                <i class="bi bi-check-circle-fill me-1" style="color: var(--health-excellent);"></i>Excellent nutritional choice
                            {% elif product.health_score >= 60 %}
                                <i class="bi bi-check-circle me-1" style="color: var(--health-good);"></i>Good nutritional option
                            {% elif product.health_score >= 40 %}
                                <i class="bi bi-exclamation-circle me-1" style="color: var(--health-fair);"></i>Fair nutritional value
                            {% else %}
                                <i class="bi bi-x-circle me-1" style="color: var(--health-poor);"></i>Consider healthier alternatives
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}

                    <!-- Quick Stats -->
                    <div class="row g-3">
                        {% if product.ecoscore %}
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: rgba(185, 251, 192, 0.2); border: 1px solid rgba(185, 251, 192, 0.5);">
                                <div class="fs-4 fw-bold mb-1" style="color: var(--health-excellent);">{{ product.ecoscore|upper }}</div>
                                <small class="fw-semibold" style="color: var(--health-excellent);">Eco Score</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if product.nova_group %}
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: rgba(255, 195, 160, 0.2); border: 1px solid rgba(255, 195, 160, 0.5);">
                                <div class="fs-4 fw-bold mb-1" style="color: var(--accent-color);">{{ product.nova_group }}</div>
                                <small class="fw-semibold" style="color: var(--accent-color);">NOVA Group</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    {% if user.is_authenticated %}
                    <div class="d-grid gap-2 mt-4">
                        <form method="post" action="{% url 'scanner:toggle_favorite' product.barcode %}" class="d-grid">
                            {% csrf_token %}
                            <button type="submit" class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %} btn-lg">
                                <i class="bi bi-heart{% if is_favorite %}-fill{% endif %} me-2"></i>
                                {% if is_favorite %}Remove from Favorites{% else %}Add to Favorites{% endif %}
                            </button>
                        </form>
                        <button class="btn btn-outline-primary btn-lg" onclick="addToNutritionTracker()">
                            <i class="bi bi-plus-circle me-2"></i>Add to Nutrition Tracker
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center mt-4">
                        <p class="mb-3" style="color: var(--text-muted);">Want to save this product?</p>
                        <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Login to Save
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <!-- Product Header -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h1 class="display-5 fw-bold mb-2" style="font-family: 'Work Sans', sans-serif; color: var(--text-primary);">
                            {{ product.name }}
                        </h1>
                        {% if product.brand %}
                        <p class="fs-5 mb-3" style="color: var(--text-muted);">
                            <i class="bi bi-building me-2"></i>{{ product.brand }}
                        </p>
                        {% endif %}
                    </div>
                    
                    <!-- Rating Display -->
                    {% if product.average_rating %}
                    <div class="text-end">
                        <div class="fs-5 mb-1" style="color: var(--accent-color);">
                            {% for i in "12345" %}
                                {% if forloop.counter <= product.average_rating %}
                                    <i class="bi bi-star-fill"></i>
                                {% else %}
                                    <i class="bi bi-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <small style="color: var(--text-muted);">
                            {{ product.average_rating|floatformat:1 }} 
                            ({{ product.review_count }} review{{ product.review_count|pluralize }})
                        </small>
                    </div>
                    {% endif %}
                </div>

                <!-- Product Meta -->
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <span class="badge px-3 py-2" style="background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color);">
                        <i class="bi bi-upc-scan me-1"></i>{{ product.barcode }}
                    </span>
                    {% if product.category %}
                    <span class="badge px-3 py-2" style="background: var(--primary-light); color: var(--primary-color); border: 1px solid var(--primary-color);">
                        <i class="bi bi-tag me-1"></i>{{ product.category }}
                    </span>
                    {% endif %}
                    {% if product.serving_size %}
                    <span class="badge px-3 py-2" style="background: rgba(255, 195, 160, 0.2); color: var(--accent-color); border: 1px solid var(--accent-color);">
                        <i class="bi bi-cup me-1"></i>{{ product.serving_size }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- NOVA Group Information -->
            {% if product.nova_group %}
            <div class="card border-0 shadow-sm mb-4" style="background: var(--card-bg); border: 1px solid var(--border-color) !important;">
                <div class="card-header bg-transparent border-0 p-4">
                    <h4 class="fw-bold mb-0" style="font-family: 'Work Sans', sans-serif; color: var(--text-primary);">
                        <i class="bi bi-info-circle me-2" style="color: var(--accent-color);"></i>Processing Level (NOVA {{ product.nova_group }})
                    </h4>
                </div>
                <div class="card-body p-4">
                    {% if nova_info %}
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="fw-semibold mb-2" style="color: var(--text-primary);">{{ nova_info.name }}</h5>
                            <p class="mb-3" style="color: var(--text-secondary);">{{ nova_info.description }}</p>
                            <div class="mb-3">
                                <h6 class="fw-semibold mb-2" style="color: var(--text-primary);">Health Impact:</h6>
                                <p class="mb-0" style="color: var(--text-secondary);">{{ nova_info.health_impact }}</p>
                            </div>
                            <div class="recommendation p-3 rounded" style="background: var(--bg-secondary); border-left: 4px solid {% if product.nova_group == 1 %}var(--health-excellent){% elif product.nova_group == 2 %}var(--accent-color){% elif product.nova_group == 3 %}var(--health-fair){% else %}var(--health-poor){% endif %};">
                                <small class="fw-medium" style="color: var(--text-primary);">
                                    <i class="bi bi-{{ nova_info.icon }} me-2"></i>{{ nova_info.recommendation }}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="nova-visual p-3">
                                <div class="nova-badge mb-3" style="background: {% if product.nova_group == 1 %}var(--health-excellent){% elif product.nova_group == 2 %}var(--accent-color){% elif product.nova_group == 3 %}var(--health-fair){% else %}var(--health-poor){% endif %}; color: var(--text-primary); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                    <span class="fs-2 fw-bold">{{ product.nova_group }}</span>
                                </div>
                                <small style="color: var(--text-muted);">Processing Level</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Environmental Impact Section -->
            {% if environmental_impact %}
            <div class="card border-0 shadow-sm mb-4" style="background: var(--card-bg); border: 1px solid var(--border-color) !important;">
                <div class="card-header bg-transparent border-0 p-4">
                    <h4 class="fw-bold mb-0" style="font-family: 'Work Sans', sans-serif; color: var(--text-primary);">
                        <i class="bi bi-globe me-2" style="color: var(--health-excellent);"></i>Environmental Impact
                    </h4>
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-3">
                                <div class="environmental-score me-3" style="background: {% if environmental_impact.grade == 'A' %}var(--health-excellent){% elif environmental_impact.grade == 'B' %}var(--health-good){% elif environmental_impact.grade == 'C' %}var(--health-fair){% elif environmental_impact.grade == 'D' %}var(--accent-color){% else %}var(--health-poor){% endif %}; color: var(--text-primary); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span class="fs-4 fw-bold">{{ environmental_impact.grade }}</span>
                                </div>
                                <div>
                                    <h5 class="fw-semibold mb-1" style="color: var(--text-primary);">Environmental Grade</h5>
                                    <p class="mb-0" style="color: var(--text-muted);">Score: {{ environmental_impact.overall_score }}/100</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 rounded" style="background: var(--bg-secondary);">
                                <div class="fs-6 fw-semibold mb-1" style="color: var(--text-primary);">Carbon Footprint</div>
                                <div class="badge" style="background: {% if environmental_impact.carbon_footprint_estimate == 'Very Low' %}var(--health-excellent){% elif environmental_impact.carbon_footprint_estimate == 'Low' %}var(--health-good){% elif environmental_impact.carbon_footprint_estimate == 'Moderate' %}var(--health-fair){% elif environmental_impact.carbon_footprint_estimate == 'High' %}var(--accent-color){% else %}var(--health-poor){% endif %}; color: var(--text-primary);">
                                    {{ environmental_impact.carbon_footprint_estimate }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impact Breakdown -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="impact-item p-3 rounded" style="background: var(--bg-secondary);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold" style="color: var(--text-primary);">Ingredients</span>
                                    <span class="badge" style="background: {% if environmental_impact.ingredient_impact.score >= 75 %}var(--health-excellent){% elif environmental_impact.ingredient_impact.score >= 50 %}var(--health-fair){% else %}var(--health-poor){% endif %}; color: var(--text-primary);">{{ environmental_impact.ingredient_impact.score }}/100</span>
                                </div>
                                {% if environmental_impact.ingredient_impact.high_impact_count > 0 %}
                                <small style="color: var(--text-muted);">{{ environmental_impact.ingredient_impact.high_impact_count }} high-impact ingredient{{ environmental_impact.ingredient_impact.high_impact_count|pluralize }}</small>
                                {% else %}
                                <small style="color: var(--text-muted);">Low environmental impact ingredients</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="impact-item p-3 rounded" style="background: var(--bg-secondary);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold" style="color: var(--text-primary);">Processing</span>
                                    <span class="badge" style="background: {% if environmental_impact.processing_impact.score >= 75 %}var(--health-excellent){% elif environmental_impact.processing_impact.score >= 50 %}var(--health-fair){% else %}var(--health-poor){% endif %}; color: var(--text-primary);">{{ environmental_impact.processing_impact.score }}/100</span>
                                </div>
                                <small style="color: var(--text-muted);">{{ environmental_impact.processing_impact.description }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Environmental Recommendations -->
                    {% if environmental_impact.recommendations %}
                    <div class="environmental-recommendations">
                        <h6 class="fw-semibold mb-3" style="color: var(--text-primary);">
                            <i class="bi bi-lightbulb me-2" style="color: var(--accent-color);"></i>Environmental Tips
                        </h6>
                        <div class="row">
                            {% for recommendation in environmental_impact.recommendations %}
                            <div class="col-12 mb-2">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-check-circle me-2 mt-1" style="color: var(--health-excellent);"></i>
                                    <small style="color: var(--text-secondary);">{{ recommendation }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Additives Analysis Section -->
            {% if additives_analysis %}
            <div class="card border-0 shadow-sm mb-4" style="background: var(--card-bg); border: 1px solid var(--border-color) !important;">
                <div class="card-header bg-transparent border-0 p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="fw-bold mb-0" style="font-family: 'Work Sans', sans-serif; color: var(--text-primary);">
                            <i class="bi bi-shield-exclamation me-2" style="color: var(--accent-color);"></i>Food Additives Analysis
                        </h4>
                        <div class="text-end">
                            <div class="additive-score" style="background: {% if additives_analysis.health_impact_score >= 80 %}var(--health-excellent){% elif additives_analysis.health_impact_score >= 60 %}var(--health-good){% elif additives_analysis.health_impact_score >= 40 %}var(--health-fair){% else %}var(--health-poor){% endif %}; color: var(--text-primary); padding: 0.5rem 1rem; border-radius: var(--border-radius); font-weight: bold;">
                                {{ additives_analysis.health_impact_score }}/100
                            </div>
                            <small style="color: var(--text-muted);">Safety Score</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if additives_analysis.total_additives > 0 %}
                    <!-- Additives Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="additives-summary p-3 rounded" style="background: var(--bg-secondary);">
                                <h6 class="fw-semibold mb-3" style="color: var(--text-primary);">Summary</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span style="color: var(--text-secondary);">Total Additives:</span>
                                    <span class="fw-semibold" style="color: var(--text-primary);">{{ additives_analysis.total_additives }}</span>
                                </div>
                                {% if additives_analysis.controversial_count > 0 %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span style="color: var(--text-secondary);">Controversial:</span>
                                    <span class="fw-semibold" style="color: var(--health-poor);">{{ additives_analysis.controversial_count }}</span>
                                </div>
                                {% endif %}
                                <div class="safety-breakdown mt-3">
                                    {% if additives_analysis.safety_summary.safe > 0 %}
                                    <div class="d-flex justify-content-between mb-1">
