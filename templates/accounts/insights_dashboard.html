{% extends 'base.html' %}
{% load static %}

{% block title %}My Analytics - Food Scanner{% endblock %}

{% block extra_css %}
<style>
    .insights-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
        min-height: 100vh;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }
    
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .chart-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-canvas {
        max-height: 350px;
        width: 100%;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: #2d3748;
    }
    
    .stat-label {
        font-size: 1rem;
        color: #718096;
        font-weight: 500;
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 15px;
        opacity: 0.7;
    }
    
    .loading-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #718096;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .recommendations-container {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .recommendation-item {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 12px;
        border-left: 5px solid #0ea5e9;
        font-size: 1rem;
        line-height: 1.6;
        color: #1e293b;
    }
    
    .recommendation-item:last-child {
        margin-bottom: 0;
    }
    
    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #718096;
        font-size: 1.1rem;
    }
    
    .no-data-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
    }
    
    .btn-custom {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary-custom {
        background: white;
        color: #4a5568;
        border: 2px solid #e2e8f0;
    }
    
    .btn-secondary-custom:hover {
        background: #f7fafc;
        border-color: #cbd5e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="insights-container">
    <!-- Redesigned header with clear purpose and navigation -->
    <div class="page-header">
        <h1>üß† My Nutrition Analytics</h1>
        <p class="page-subtitle">Your personalized insights and AI-powered recommendations</p>
    </div>
    
    <!-- Added clear action buttons for navigation and data refresh -->
    <div class="action-buttons">
        <a href="{% url 'accounts:dashboard' %}" class="btn btn-custom btn-secondary-custom">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <button id="refreshInsights" class="btn btn-custom btn-primary-custom">
            <i class="fas fa-sync-alt"></i> Refresh Analysis
        </button>
    </div>
    
    <!-- Redesigned summary statistics with better visual hierarchy -->
    <div class="stats-grid" id="summaryStats">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Analyzing your nutrition data...</p>
        </div>
    </div>
    
    <!-- Enhanced weekly trends chart with better styling -->
    <div class="chart-container">
        <h3 class="chart-title">
            <span>üìà</span>
            Weekly Nutrition Trends
        </h3>
        <div id="weeklyTrendsContainer">
            <canvas id="weeklyTrendsChart" class="chart-canvas"></canvas>
        </div>
    </div>
    
    <!-- Renamed and redesigned macronutrient distribution chart -->
    <div class="chart-container">
        <h3 class="chart-title">
            <span>ü•ó</span>
            Macronutrient Distribution
        </h3>
        <div id="macroDistributionContainer">
            <canvas id="macroDistributionChart" class="chart-canvas"></canvas>
        </div>
    </div>
    
    <!-- Enhanced balance score visualization -->
    <div class="chart-container">
        <h3 class="chart-title">
            <span>‚öñÔ∏è</span>
            Diet Balance Score
        </h3>
        <div id="balanceScoreContainer">
            <canvas id="balanceScoreChart" class="chart-canvas"></canvas>
        </div>
    </div>
    
    <!-- Redesigned recommendations section with better styling -->
    <div class="recommendations-container">
        <h3 class="chart-title">
            <span>üí°</span>
            AI-Generated Recommendations
        </h3>
        <div id="recommendationsList">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Generating personalized recommendations...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let charts = {};
    
    function loadInsights() {
        showLoadingState();
        
        fetch('/accounts/api/ml-insights/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderInsightsData(data);
            } else {
                showError('Analysis failed: ' + (data.message || 'Unable to generate insights'));
            }
        })
        .catch(error => {
            console.error('Error loading insights:', error);
            showError('Unable to load your nutrition insights. Please try refreshing the page.');
        });
    }
    
    function showLoadingState() {
        document.getElementById('summaryStats').innerHTML = `
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Analyzing your nutrition data...</p>
            </div>
        `;
        document.getElementById('recommendationsList').innerHTML = `
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Generating personalized recommendations...</p>
            </div>
        `;
    }
    
    function renderInsightsData(data) {
        renderEnhancedSummaryStats(data.insights);
        renderDynamicCharts(data.insights, data.charts_data);
        renderPersonalizedRecommendations(data.insights);
    }
    
    function renderEnhancedSummaryStats(insights) {
        const container = document.getElementById('summaryStats');
        
        if (insights.basic_analysis) {
            // New user experience
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üå±</div>
                    <div class="stat-value">Getting Started</div>
                    <div class="stat-label">Analysis Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value">${insights.scanned_items || 0}</div>
                    <div class="stat-label">Items Scanned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value">Ready</div>
                    <div class="stat-label">Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí™</div>
                    <div class="stat-value">Keep Going!</div>
                    <div class="stat-label">Motivation</div>
                </div>
            `;
        } else {
            // Advanced user experience
            const balanceScore = insights.nutrition_balance ? Math.round(insights.nutrition_balance.balance_score) : 0;
            const streakDays = insights.tracking_streak || 0;
            const totalScans = insights.total_scans || 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üß†</div>
                    <div class="stat-value">Advanced</div>
                    <div class="stat-label">Analysis Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚öñÔ∏è</div>
                    <div class="stat-value">${balanceScore}/100</div>
                    <div class="stat-label">Balance Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value">${streakDays}</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value">${totalScans}</div>
                    <div class="stat-label">Total Scans</div>
                </div>
            `;
        }
    }
    
    function renderDynamicCharts(insights, chartsData) {
        if (chartsData && chartsData.has_data) {
            renderWeeklyNutritionTrends(chartsData.weekly_trends);
            renderMacronutrientDistribution(insights);
            renderBalanceScoreGauge(insights);
        } else {
            renderNewUserCharts();
        }
    }
    
    function renderWeeklyNutritionTrends(trendsData) {
        const ctx = document.getElementById('weeklyTrendsChart').getContext('2d');
        if (charts.weeklyTrends) charts.weeklyTrends.destroy();
        
        const defaultData = {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [
                {
                    label: 'Calories',
                    data: [1800, 2100, 1950, 2200, 1900, 2400, 2000],
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Protein (g)',
                    data: [80, 95, 85, 100, 88, 110, 92],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Carbs (g)',
                    data: [200, 250, 220, 280, 210, 300, 240],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }
            ]
        };
        
        charts.weeklyTrends = new Chart(ctx, {
            type: 'line',
            data: trendsData || defaultData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f1f5f9'
                        }
                    },
                    x: {
                        grid: {
                            color: '#f1f5f9'
                        }
                    }
                }
            }
        });
    }
    
    function renderMacronutrientDistribution(insights) {
        const ctx = document.getElementById('macroDistributionChart').getContext('2d');
        if (charts.macroDistribution) charts.macroDistribution.destroy();
        
        let data = {
            labels: ['Protein', 'Fats', 'Carbohydrates'],
            datasets: [{
                data: [25, 30, 45],
                backgroundColor: ['#0ea5e9', '#f59e0b', '#10b981'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        };
        
        if (insights.nutrition_balance && insights.nutrition_balance.current_ratios) {
            const ratios = insights.nutrition_balance.current_ratios;
            data.datasets[0].data = [
                Math.round(ratios.protein * 100),
                Math.round(ratios.fat * 100),
                Math.round(ratios.carbs * 100)
            ];
        }
        
        charts.macroDistribution = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            }
        });
    }
    
    function renderBalanceScoreGauge(insights) {
        const ctx = document.getElementById('balanceScoreChart').getContext('2d');
        if (charts.balanceScore) charts.balanceScore.destroy();
        
        const score = insights.nutrition_balance ? Math.round(insights.nutrition_balance.balance_score) : 72;
        
        charts.balanceScore = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Balance Score', 'Remaining'],
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: ['#10b981', '#f1f5f9'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    
                    ctx.restore();
                    const fontSize = (height / 114).toFixed(2);
                    ctx.font = fontSize + "em sans-serif";
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = "#2d3748";
                    
                    const text = score + "/100";
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;
                    
                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }]
        });
    }
    
    function renderNewUserCharts() {
        renderWeeklyNutritionTrends(null);
        renderMacronutrientDistribution({});
        renderBalanceScoreGauge({});
    }
    
    function renderPersonalizedRecommendations(insights) {
        const container = document.getElementById('recommendationsList');
        
        if (insights.recommendations && insights.recommendations.length > 0) {
            container.innerHTML = insights.recommendations.map(rec => 
                `<div class="recommendation-item">${rec}</div>`
            ).join('');
        } else if (insights.basic_analysis) {
            container.innerHTML = `
                <div class="recommendation-item">
                    üåü Welcome to Food Scanner! Start by scanning some food items to get personalized nutrition insights.
                </div>
                <div class="recommendation-item">
                    üì± Try scanning different types of foods throughout the day to build your nutrition profile.
                </div>
                <div class="recommendation-item">
                    üéØ Set your daily nutrition goals in your profile to get targeted recommendations.
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="recommendation-item">
                    Keep tracking your nutrition consistently to receive more personalized AI recommendations!
                </div>
            `;
        }
    }
    
    function showError(message) {
        const container = document.getElementById('summaryStats');
        container.innerHTML = `
            <div class="stat-card" style="grid-column: 1 / -1;">
                <div class="no-data-message">
                    <div class="no-data-icon">‚ö†Ô∏è</div>
                    <p>${message}</p>
                    <button onclick="loadInsights()" class="btn btn-custom btn-primary-custom" style="margin-top: 15px;">
                        Try Again
                    </button>
                </div>
            </div>
        `;
    }
    
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    document.getElementById('refreshInsights').addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        this.disabled = true;
        
        setTimeout(() => {
            loadInsights();
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Analysis';
            this.disabled = false;
        }, 1000);
    });
    
    // Initial load
    loadInsights();
});
</script>
{% endblock %}
