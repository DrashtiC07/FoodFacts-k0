{% extends 'base.html' %}
{% load static %}

{% block title %}Nutrition Insights Dashboard - Food Scanner{% endblock %}

{% block extra_css %}
<style>
    .insights-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2d3748;
    }
    
    .chart-canvas {
        max-height: 400px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 1.2rem;
        color: #666;
    }
    
    .recommendations-list {
        list-style: none;
        padding: 0;
    }
    
    .recommendation-item {
        background: #f7fafc;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #4299e1;
    }
</style>
{% endblock %}

{% block content %}
<div class="insights-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">ðŸ§  Nutrition Insights Dashboard</h1>
        <div>
            <a href="{% url 'accounts:dashboard' %}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <button id="refreshInsights" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="stats-grid" id="summaryStats">
        <div class="loading-spinner">Loading insights...</div>
    </div>
    
    <!-- Weekly Trends Chart -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸ“ˆ Weekly Nutrition Trends</h3>
        <canvas id="weeklyTrendsChart" class="chart-canvas"></canvas>
    </div>
    
    <!-- Nutrition Distribution -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸ¥— Nutrition Distribution</h3>
        <canvas id="nutritionHistogramChart" class="chart-canvas"></canvas>
    </div>
    
    <!-- Goal Achievement -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸŽ¯ Goal Achievement Rate</h3>
        <canvas id="goalAchievementChart" class="chart-canvas"></canvas>
    </div>
    
    <!-- Recommendations -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸ’¡ Personalized Recommendations</h3>
        <ul class="recommendations-list" id="recommendationsList">
            <div class="loading-spinner">Loading recommendations...</div>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let charts = {};
    
    function loadInsights() {
        fetch('/accounts/api/ml-insights/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderInsightsData(data);
            } else {
                showError('Failed to load insights: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading insights:', error);
            showError('Failed to load insights. Please try again.');
        });
    }
    
    function renderInsightsData(data) {
        renderSummaryStats(data.insights);
        renderChartsFromInsights(data.insights, data.charts_data);
        renderRecommendations(data.insights.recommendations || []);
    }
    
    function renderSummaryStats(insights) {
        const container = document.getElementById('summaryStats');
        
        if (insights.basic_analysis) {
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">New User</div>
                    <div class="stat-label">Analysis Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${insights.current_progress ? Math.round(insights.current_progress.calories) : 0}%</div>
                    <div class="stat-label">Calorie Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${insights.current_progress ? Math.round(insights.current_progress.protein) : 0}%</div>
                    <div class="stat-label">Protein Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Getting Started</div>
                    <div class="stat-label">Status</div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">Advanced</div>
                    <div class="stat-label">Analysis Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${insights.nutrition_balance ? Math.round(insights.nutrition_balance.balance_score) : 0}%</div>
                    <div class="stat-label">Balance Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${insights.goal_prediction ? insights.goal_prediction.prediction : 'N/A'}</div>
                    <div class="stat-label">Goal Prediction</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Tracking</div>
                    <div class="stat-label">Status</div>
                </div>
            `;
        }
    }
    
    function renderChartsFromInsights(insights, chartsData) {
        if (chartsData && chartsData.has_data) {
            renderWeeklyTrends(chartsData.weekly_trends);
            renderNutritionHistogram(insights);
            renderGoalAchievement(insights);
        } else {
            renderPlaceholderCharts();
        }
    }
    
    function renderWeeklyTrends(data) {
        const ctx = document.getElementById('weeklyTrendsChart').getContext('2d');
        if (charts.weeklyTrends) charts.weeklyTrends.destroy();
        
        charts.weeklyTrends = new Chart(ctx, {
            type: 'line',
            data: data || {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'No Data Available',
                    data: [0, 0, 0, 0],
                    borderColor: '#ccc',
                    backgroundColor: 'rgba(204, 204, 204, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }
    
    function renderNutritionHistogram(insights) {
        const ctx = document.getElementById('nutritionHistogramChart').getContext('2d');
        if (charts.nutritionHistogram) charts.nutritionHistogram.destroy();
        
        let data = {
            labels: ['Protein', 'Fat', 'Carbs'],
            datasets: [{
                label: 'Current Balance',
                data: [25, 30, 45], // Default balanced ratios
                backgroundColor: ['#0ea5e9', '#f59e0b', '#10b981']
            }]
        };
        
        if (insights.nutrition_balance && insights.nutrition_balance.current_ratios) {
            const ratios = insights.nutrition_balance.current_ratios;
            data.datasets[0].data = [
                Math.round(ratios.protein * 100),
                Math.round(ratios.fat * 100),
                Math.round(ratios.carbs * 100)
            ];
        }
        
        charts.nutritionHistogram = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }
    
    function renderGoalAchievement(insights) {
        const ctx = document.getElementById('goalAchievementChart').getContext('2d');
        if (charts.goalAchievement) charts.goalAchievement.destroy();
        
        let achievementData = {
            labels: ['Goals Met', 'Goals Remaining'],
            datasets: [{
                data: [70, 30], // Default values
                backgroundColor: ['#10b981', '#f3f4f6']
            }]
        };
        
        if (insights.current_progress) {
            const avgProgress = (insights.current_progress.calories + insights.current_progress.protein) / 2;
            achievementData.datasets[0].data = [Math.round(avgProgress), Math.round(100 - avgProgress)];
        }
        
        charts.goalAchievement = new Chart(ctx, {
            type: 'doughnut',
            data: achievementData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }
    
    function renderPlaceholderCharts() {
        renderWeeklyTrends(null);
        renderNutritionHistogram({});
        renderGoalAchievement({});
    }
    
    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsList');
        if (recommendations && recommendations.length > 0) {
            container.innerHTML = recommendations.map(rec => 
                `<li class="recommendation-item">${rec}</li>`
            ).join('');
        } else {
            container.innerHTML = '<li class="recommendation-item">Keep tracking your nutrition to get personalized recommendations!</li>';
        }
    }
    
    function showError(message) {
        const container = document.getElementById('summaryStats');
        container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners
    document.getElementById('refreshInsights').addEventListener('click', loadInsights);
    
    // Initial load
    loadInsights();
});
</script>
{% endblock %}
