{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Food Facts Scanner{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Modern Dashboard Header -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="mb-3 mb-md-0">
          <h1 class="display-5 fw-bold mb-2" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-speedometer2 me-3 text-primary"></i>Dashboard
          </h1>
          <p class="text-muted fs-5 mb-0">Welcome back, <strong>{{ user.get_full_name|default:user.username }}</strong>!</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
            <i class="bi bi-gear me-1"></i>Set Goals
          </button>
          <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
            <i class="bi bi-camera me-1"></i>Scan Product
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Stats Cards -->
  <div class="row mb-5">
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 p-3 mb-3">
            <i class="bi bi-upc-scan fs-2 text-primary"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ scan_history|length }}</h3>
          <p class="text-muted mb-0">Products Scanned</p>
          <small class="text-success">
            <i class="bi bi-arrow-up"></i> +{{ recent_scans_count }} this week
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-danger bg-opacity-10 p-3 mb-3">
            <i class="bi bi-heart-fill fs-2 text-danger"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ favorite_products|length }}</h3>
          <p class="text-muted mb-0">Favorite Products</p>
          <small class="text-info">
            <i class="bi bi-star"></i> Top rated items
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10 p-3 mb-3">
            <i class="bi bi-star-fill fs-2 text-warning"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ user_reviews|length }}</h3>
          <p class="text-muted mb-0">Reviews Written</p>
          <small class="text-warning">
            <i class="bi bi-chat"></i> Community contributor
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 p-3 mb-3">
            <i class="bi bi-calendar-check fs-2 text-success"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ days_active }}</h3>
          <p class="text-muted mb-0">Days Active</p>
          <small class="text-success">
            <i class="bi bi-trophy"></i> Keep it up!
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Nutrition Goals Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="fw-bold mb-1" style="font-family: 'Manrope', sans-serif;">
                <i class="bi bi-bullseye me-2 text-primary"></i>Daily Nutrition Goals
              </h4>
              <p class="text-muted mb-0">Track your daily nutrition intake and goals</p>
            </div>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
              <i class="bi bi-gear me-1"></i>Adjust Goals
            </button>
          </div>
        </div>
        <div class="card-body p-4">
          {% if dietary_goals %}
          <div class="row">
            <!-- Enhanced progress bars with completion-based colors and tooltips -->
            <!-- Calories -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="calories">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-primary">
                    <i class="bi bi-fire me-1"></i>Calories
                  </span>
                  <span class="badge bg-primary bg-opacity-10 text-primary" 
                        data-bs-toggle="tooltip" 
                        title="{% if calories_progress < 50 %}Low intake - consider adding healthy snacks{% elif calories_progress > 100 %}Over target - monitor portion sizes{% else %}Good progress towards your goal{% endif %}">
                    {{ dietary_goals.calories_consumed }}/{{ dietary_goals.calories_target }}
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if calories_progress == 0 %}No data logged yet - start by scanning products or adding manual entries{% else %}{{ calories_progress|floatformat:1 }}% of daily goal completed{% endif %}">
                  <div class="progress-fill progress-bar calories-progress" 
                       style="width: {{ calories_progress|floatformat:1 }}%; 
                              background: {% if calories_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif calories_progress <= 80 %}linear-gradient(90deg, #ffc107, #fd7e14){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ calories_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="calories">{{ calories_remaining }} kcal left</small>
                </div>
              </div>
            </div>
            
            <!-- Protein -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="protein">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-info">
                    <i class="bi bi-egg me-1"></i>Protein
                  </span>
                  <span class="badge bg-info bg-opacity-10 text-info"
                        data-bs-toggle="tooltip" 
                        title="{% if protein_progress < 50 %}Low protein - add lean meats, beans, or nuts{% elif protein_progress > 100 %}Excellent protein intake{% else %}Good protein progress{% endif %}">
                    {{ dietary_goals.protein_consumed }}/{{ dietary_goals.protein_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if protein_progress == 0 %}No protein logged yet{% else %}{{ protein_progress|floatformat:1 }}% of protein goal completed{% endif %}">
                  <div class="progress-fill progress-bar protein-progress" 
                       style="width: {{ protein_progress|floatformat:1 }}%; 
                              background: {% if protein_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif protein_progress <= 80 %}linear-gradient(90deg, #0ea5e9, #06b6d4){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ protein_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="protein">{{ protein_remaining }}g left</small>
                </div>
              </div>
            </div>
            
            <!-- Fat -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="fat">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-warning">
                    <i class="bi bi-droplet me-1"></i>Fat
                  </span>
                  <span class="badge bg-warning bg-opacity-10 text-warning"
                        data-bs-toggle="tooltip" 
                        title="{% if fat_progress < 50 %}Low fat intake - add healthy fats like avocado or nuts{% elif fat_progress > 100 %}High fat intake - monitor portions{% else %}Balanced fat intake{% endif %}">
                    {{ dietary_goals.fat_consumed }}/{{ dietary_goals.fat_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if fat_progress == 0 %}No fat logged yet{% else %}{{ fat_progress|floatformat:1 }}% of fat goal completed{% endif %}">
                  <div class="progress-fill progress-bar fat-progress" 
                       style="width: {{ fat_progress|floatformat:1 }}%; 
                              background: {% if fat_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif fat_progress <= 80 %}linear-gradient(90deg, #ffc107, #f59e0b){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ fat_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="fat">{{ fat_remaining }}g left</small>
                </div>
              </div>
            </div>
            
            <!-- Carbs -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="carbs">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-success">
                    <i class="bi bi-grain me-1"></i>Carbs
                  </span>
                  <span class="badge bg-success bg-opacity-10 text-success"
                        data-bs-toggle="tooltip" 
                        title="{% if carbs_progress < 50 %}Low carb intake - add whole grains or fruits{% elif carbs_progress > 100 %}High carb intake - focus on complex carbs{% else %}Good carb balance{% endif %}">
                    {{ dietary_goals.carbs_consumed }}/{{ dietary_goals.carbs_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if carbs_progress == 0 %}No carbs logged yet{% else %}{{ carbs_progress|floatformat:1 }}% of carb goal completed{% endif %}">
                  <div class="progress-fill progress-bar carbs-progress" 
                       style="width: {{ carbs_progress|floatformat:1 }}%; 
                              background: {% if carbs_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif carbs_progress <= 80 %}linear-gradient(90deg, #198754, #10b981){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ carbs_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="carbs">{{ carbs_remaining }}g left</small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Added enhanced analytics and achievement tracking -->
          <div class="row mt-4">
            <div class="col-md-6 mb-4">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="fw-semibold mb-3">
                    <i class="bi bi-graph-up me-2 text-success"></i>Weekly Progress
                  </h6>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Scans this week</span>
                    <span class="fw-semibold text-success">{{ recent_scans_count }}</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Goal completion</span>
                    <span class="fw-semibold text-primary">
                      {% widthratio calories_progress 100 100 %}%
                    </span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">Streak</span>
                    <span class="fw-semibold text-warning">{{ days_active }} days</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-4">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="fw-semibold mb-3">
                    <i class="bi bi-trophy me-2 text-warning"></i>Achievements
                  </h6>
                  {% if scan_history|length >= 10 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Scanner Pro (10+ scans)</span>
                  </div>
                  {% endif %}
                  {% if user_reviews|length >= 5 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Reviewer (5+ reviews)</span>
                  </div>
                  {% endif %}
                  {% if favorite_products|length >= 3 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Curator (3+ favorites)</span>
                  </div>
                  {% endif %}
                  {% if days_active >= 7 %}
                  <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Consistent User (7+ days)</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Manual Nutrition Input Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card border-0 bg-light">
                <div class="card-header bg-transparent border-0 p-3">
                  <h6 class="fw-bold mb-0">
                    <i class="bi bi-plus-circle me-2 text-primary"></i>Add Manual Entry
                  </h6>
                </div>
                <div class="card-body p-3">
                  <form id="manualNutritionForm" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-3">
                      <label class="form-label small">Calories</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualCalories" placeholder="0" min="0" max="5000">
                        <span class="input-group-text">kcal</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Protein</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualProtein" placeholder="0" min="0" max="200">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Fat</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualFat" placeholder="0" min="0" max="200">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Carbs</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualCarbs" placeholder="0" min="0" max="300">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small">&nbsp;</label>
                      <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-plus me-1"></i>Add to Today
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="resetDailyGoals()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Reset Today
                </button>
                <a href="{% url 'scanner:scan' %}" class="btn btn-sm btn-primary">
                  <i class="bi bi-plus-circle me-1"></i>Add Food
                </a>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#nutritionTipsModal">
                  <i class="bi bi-lightbulb me-1"></i>Tips
                </button>
                <!-- Added export functionality for user data -->
                <button class="btn btn-sm btn-outline-info" onclick="exportNutritionData()">
                  <i class="bi bi-download me-1"></i>Export Data
                </button>
              </div>
            </div>
          </div>
          {% else %}
          <!-- No goals set yet -->
          <div class="text-center py-5">
            <i class="bi bi-bullseye display-1 text-muted mb-3"></i>
            <h5 class="fw-semibold mb-3">Set Your Nutrition Goals</h5>
            <p class="text-muted mb-4">Start tracking your daily nutrition by setting personalized goals</p>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
              <i class="bi bi-plus-circle me-2"></i>Set My Goals
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Added comprehensive Recent Activity section with enhanced scan logging -->
  <div class="row mb-5">
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">
              <i class="bi bi-clock-history me-2 text-primary"></i>Recent Activity
            </h5>
            <a href="{% url 'scanner:history' %}" class="btn btn-sm btn-outline-primary">
              View All History
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          {% if scan_history %}
          <div class="list-group list-group-flush">
            {% for scan in scan_history %}
            <div class="list-group-item border-0 py-3 px-4">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  {% if scan.product.image_url %}
                  <img src="{{ scan.product.image_url }}" alt="{{ scan.product.name }}" 
                       class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                  {% else %}
                  <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                       style="width: 50px; height: 50px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                  {% endif %}
                </div>
                <div class="flex-grow-1">
                  {% if scan.product.barcode %}
                  <a href="{% url 'scanner:product_detail' scan.product.barcode %}" 
                     class="text-decoration-none product-link" style="padding-top: 80px;">
                    <h6 class="mb-1 fw-semibold">{{ scan.product.name|truncatechars:40 }}</h6>
                  </a>
                  {% else %}
                  <h6 class="mb-1 fw-semibold text-muted">{{ scan.product.name|truncatechars:40 }}</h6>
                  {% endif %}
                  <div class="d-flex align-items-center gap-3">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>{{ scan.scanned_at|timesince }} ago
                    </small>
                    {% if scan.product.brand %}
                    <small class="text-muted">
                      <i class="bi bi-building me-1"></i>{{ scan.product.brand }}
                    </small>
                    {% endif %}
                    {% if scan.product.health_score %}
                    <span class="badge badge-sm 
                      {% if scan.product.health_score >= 80 %}bg-success
                      {% elif scan.product.health_score >= 60 %}bg-warning
                      {% else %}bg-danger{% endif %}">
                      Health: {{ scan.product.health_score }}/100
                    </span>
                    {% endif %}
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <i class="bi bi-chevron-right text-muted"></i>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-upc-scan display-1 text-muted mb-3"></i>
            <h6 class="fw-semibold mb-2">No Scans Yet</h6>
            <p class="text-muted mb-4">Start scanning products to see your activity here</p>
            <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
              <i class="bi bi-camera me-2"></i>Scan Your First Product
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Added Quick Stats sidebar with personalized insights -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 p-4">
          <h6 class="fw-bold mb-0">
            <i class="bi bi-pie-chart me-2 text-primary"></i>Quick Stats
          </h6>
        </div>
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Total Products</span>
            <span class="fw-bold">{{ scan_history|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Favorites</span>
            <span class="fw-bold text-danger">{{ favorite_products|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Reviews</span>
            <span class="fw-bold text-warning">{{ user_reviews|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Member Since</span>
            <span class="fw-bold text-success">{{ user.date_joined|date:"M Y" }}</span>
          </div>
        </div>
      </div>

      <!-- Fixed personalized tips to always show content and not disappear -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <h6 class="fw-bold mb-0">
            <i class="bi bi-lightbulb me-2 text-warning"></i>Personalized Tips
          </h6>
        </div>
        <div class="card-body p-4" id="personalizedTipsContent">
          <!-- Always show at least one tip -->
          <div class="alert alert-success alert-sm mb-3">
            <i class="bi bi-trophy me-2"></i>
            <small>Keep up the great work! You've been active for {{ days_active|default:1 }} days.</small>
          </div>
          
          {% if calories_progress < 50 %}
          <div class="alert alert-info alert-sm mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <small>You're under your calorie goal. Consider adding a healthy snack!</small>
          </div>
          {% endif %}
          
          {% if protein_progress < 70 %}
          <div class="alert alert-warning alert-sm mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <small>Boost your protein intake with lean meats, beans, or nuts.</small>
          </div>
          {% endif %}
          
          {% if recent_scans_count == 0 %}
          <div class="alert alert-primary alert-sm mb-3">
            <i class="bi bi-camera me-2"></i>
            <small>Scan a product this week to track your nutrition!</small>
          </div>
          {% else %}
          <div class="alert alert-info alert-sm mb-3">
            <i class="bi bi-graph-up me-2"></i>
            <small>Great job! You've scanned {{ recent_scans_count }} product{{ recent_scans_count|pluralize }} this week.</small>
          </div>
          {% endif %}
          
          <!-- Weekly sugar intake tip -->
          {% if sugar_progress > 80 %}
          <div class="alert alert-warning alert-sm mb-3">
            <i class="bi bi-exclamation-circle me-2"></i>
            <small>Your sugar intake is high this week. Try choosing low-sugar alternatives.</small>
          </div>
          {% elif sugar_progress < 30 %}
          <div class="alert alert-success alert-sm mb-3">
            <i class="bi bi-check-circle me-2"></i>
            <small>Excellent! You're keeping your sugar intake low this week.</small>
          </div>
          {% endif %}
          
          <!-- Hydration reminder -->
          <div class="alert alert-info alert-sm">
            <i class="bi bi-droplet me-2"></i>
            <small>Remember to stay hydrated! Aim for 8 glasses of water daily.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Sections -->
  <div class="row">
    <!-- Scan History (moved from navbar) -->
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
              <i class="bi bi-clock-history me-2 text-primary"></i>Recent Scans
            </h5>
            <a href="{% url 'scanner:history' %}" class="btn btn-sm btn-outline-primary">
              View All History
            </a>
          </div>
        </div>
        <div class="card-body p-4">
          {% if scan_history %}
            {% for scan in scan_history %}
            <div class="d-flex align-items-center mb-3 p-3 rounded-3 bg-light bg-opacity-50 {% if not forloop.last %}mb-3{% endif %}">
              <div class="product-image me-3">
                {% if scan.product.image_url %}
                <img
                  src="{{ scan.product.image_url }}"
                  alt="{{ scan.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-semibold">
                  <a href="{% url 'scanner:product_detail' scan.product.barcode %}" class="text-decoration-none text-dark product-link" style="padding-top: 20px; display: inline-block;">
                    {{ scan.product.name|truncatechars:35 }}
                  </a>
                </h6>
                <div class="d-flex align-items-center gap-2 mb-1">
                  {% if scan.product.health_score %}
                  <span class="badge bg-{{ scan.product.health_score|lower }} badge-sm">
                    {{ scan.product.health_score }}
                  </span>
                  {% endif %}
                  <small class="text-muted">{{ scan.product.brand|default:"Unknown Brand" }}</small>
                </div>
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>{{ scan.scanned_at|timesince }} ago
                </small>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-upc-scan display-1 text-muted mb-3"></i>
              <h6 class="fw-semibold mb-2">No scans yet</h6>
              <p class="text-muted mb-3">Start scanning products to see your history here</p>
              <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
                <i class="bi bi-camera me-1"></i>Start Scanning
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Favorite Products -->
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 p-4">
          <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-heart-fill me-2 text-danger"></i>Favorite Products
          </h5>
        </div>
        <div class="card-body p-4">
          {% if favorite_products %}
            {% for favorite in favorite_products %}
            <div class="d-flex align-items-center mb-3 p-3 rounded-3 bg-light bg-opacity-50">
              <div class="product-image me-3">
                {% if favorite.product.image_url %}
                <img
                  src="{{ favorite.product.image_url }}"
                  alt="{{ favorite.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-semibold">
                  <a href="{% url 'scanner:product_detail' favorite.product.barcode %}" class="text-decoration-none text-dark product-link" style="padding-top: 20px; display: inline-block;">
                    {{ favorite.product.name|truncatechars:35 }}
                  </a>
                </h6>
                <div class="d-flex align-items-center gap-2 mb-1">
                  {% if favorite.product.health_score %}
                  <span class="badge bg-{{ favorite.product.health_score|lower }} badge-sm">
                    {{ favorite.product.health_score }}
                  </span>
                  {% endif %}
                  <small class="text-muted">{{ favorite.product.brand|default:"Unknown Brand" }}</small>
                </div>
                <small class="text-muted">
                  <i class="bi bi-heart me-1"></i>Added {{ favorite.added_at|timesince }} ago
                </small>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-heart display-1 text-muted mb-3"></i>
              <h6 class="fw-semibold mb-2">No favorites yet</h6>
              <p class="text-muted mb-3">Add products to your favorites to see them here</p>
              <a href="{% url 'scanner:search' %}" class="btn btn-outline-primary">
                <i class="bi bi-search me-1"></i>Discover Products
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Reviews -->
  {% if user_reviews %}
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-star-fill me-2 text-warning"></i>Your Recent Reviews
          </h5>
        </div>
        <div class="card-body p-4">
          {% for review in user_reviews %}
          <div class="mb-4 p-3 rounded-3 bg-light bg-opacity-50 {% if not forloop.last %}mb-4{% endif %}">
            <div class="d-flex align-items-start">
              <div class="product-image me-3">
                {% if review.product.image_url %}
                <img
                  src="{{ review.product.image_url }}"
                  alt="{{ review.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-2 fw-semibold">
                  <a href="{% url 'scanner:product_detail' review.product.barcode %}" class="text-decoration-none text-dark product-link" style="padding-top: 20px; display: inline-block;">
                    {{ review.product.name }}
                  </a>
                </h6>
                <div class="mb-2">
                  {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}
                      <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-muted"></i>
                    {% endif %}
                  {% endfor %}
                  <small class="text-muted ms-2">{{ review.created_at|date:"M d, Y" }}</small>
                </div>
                {% if review.review_text %}
                <p class="mb-0 text-muted">{{ review.review_text|truncatechars:120 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Enhanced nutrition goals modal with sugar and sodium tracking -->
<div class="modal fade" id="nutritionGoalsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold" style="font-family: 'Manrope', sans-serif;">
          <i class="bi bi-bullseye me-2 text-primary"></i>Set Nutrition Goals
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="nutritionGoalsForm" method="post" action="{% url 'accounts:update_nutrition_goals' %}">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Calories Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="calories_target" id="calories_target"
                       value="{{ dietary_goals.calories_target|default:2000 }}" min="1000" max="5000">
                <span class="input-group-text">kcal</span>
              </div>
              <small class="form-text text-muted">Recommended: 1800-2500 kcal/day</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Protein Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="protein_target" id="protein_target"
                       value="{{ dietary_goals.protein_target|default:50 }}" min="20" max="200">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 0.8-1.2g per kg body weight</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Fat Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="fat_target" id="fat_target"
                       value="{{ dietary_goals.fat_target|default:70 }}" min="20" max="150">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 20-35% of total calories</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Carbs Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="carbs_target" id="carbs_target"
                       value="{{ dietary_goals.carbs_target|default:300 }}" min="50" max="500">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 45-65% of total calories</small>
            </div>
            <!-- Added sugar and sodium target inputs -->
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Sugar Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="sugar_target" id="sugar_target"
                       value="{{ dietary_goals.sugar_target|default:50 }}" min="10" max="200">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">WHO recommends: <25g/day</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Sodium Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="sodium_target" id="sodium_target"
                       value="{{ dietary_goals.sodium_target|default:2300 }}" min="500" max="5000">
                <span class="input-group-text">mg</span>
              </div>
              <small class="form-text text-muted">WHO recommends: <2000mg/day</small>
            </div>
          </div>
          
          <!-- Enhanced Quick Presets with confirmation modal -->
          <!-- Quick Presets -->
          <div class="mt-4">
            <h6 class="fw-semibold mb-3">Quick Presets</h6>
            <div class="row">
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="weight-loss">
                  <i class="bi bi-arrow-down-circle me-1"></i>Weight Loss
                </button>
              </div>
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="maintenance">
                  <i class="bi bi-dash-circle me-1"></i>Maintenance
                </button>
              </div>
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="muscle-gain">
                  <i class="bi bi-arrow-up-circle me-1"></i>Muscle Gain
                </button>
              </div>
            </div>
            <small class="text-muted">Click a preset to automatically fill in recommended values</small>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="nutritionGoalsForm" class="btn btn-primary" id="saveGoalsBtn">
          <i class="bi bi-check-circle me-1"></i>Save Goals
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Nutrition Tips Modal -->
<div class="modal fade" id="nutritionTipsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-lightbulb me-2 text-warning"></i>Nutrition Tips
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Stay Hydrated</h6>
            <p class="text-muted mb-0">Drink at least 8 glasses of water daily for optimal health.</p>
          </div>
        </div>
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Balanced Meals</h6>
            <p class="text-muted mb-0">Include protein, healthy fats, and complex carbs in each meal.</p>
          </div>
        </div>
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Portion Control</h6>
            <p class="text-muted mb-0">Use smaller plates and listen to your hunger cues.</p>
          </div>
        </div>
        <div class="d-flex align-items-start">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Regular Meals</h6>
            <p class="text-muted mb-0">Eat at consistent times to maintain stable energy levels.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Added Preset Confirmation Modal -->
<!-- Preset Confirmation Modal -->
<div class="modal fade" id="presetConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-question-circle me-2 text-primary"></i>Apply Preset Goals?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="mb-3">Are you sure you want to apply the <strong id="presetTypeName"></strong> preset? This will replace your current goal values.</p>
        <div class="bg-light rounded p-3">
          <h6 class="fw-semibold mb-2">New Goals:</h6>
          <div class="row text-sm">
            <div class="col-6">
              <div class="mb-1"><strong>Calories:</strong> <span id="presetCalories"></span> kcal</div>
              <div class="mb-1"><strong>Protein:</strong> <span id="presetProtein"></span>g</div>
              <div class="mb-1"><strong>Fat:</strong> <span id="presetFat"></span>g</div>
            </div>
            <div class="col-6">
              <div class="mb-1"><strong>Carbs:</strong> <span id="presetCarbs"></span>g</div>
              <div class="mb-1"><strong>Sugar:</strong> <span id="presetSugar"></span>g</div>
              <div class="mb-1"><strong>Sodium:</strong> <span id="presetSodium"></span>mg</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmPresetBtn">
          <i class="bi bi-check-circle me-1"></i>Apply Preset
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.nutrition-goal-card {
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: all var(--transition-fast);
}

.nutrition-goal-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.nutrition-bar {
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  background-color: var(--bg-tertiary);
  position: relative;
}

.nutrition-bar .progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), #06b6d4);
  border-radius: 6px;
  transition: width var(--transition-slow);
  position: relative;
  overflow: hidden;
}

.nutrition-bar .progress-fill.bg-info {
  background: linear-gradient(90deg, #0ea5e9, #06b6d4);
}

.nutrition-bar .progress-fill.bg-warning {
  background: linear-gradient(90deg, var(--accent-color), #f59e0b);
}

.nutrition-bar .progress-fill.bg-success {
  background: linear-gradient(90deg, var(--health-excellent), #10b981);
}

.badge-sm {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
}

.badge.bg-a { background-color: var(--health-excellent) !important; }
.badge.bg-b { background-color: var(--health-good) !important; }
.badge.bg-c { background-color: var(--health-fair) !important; color: #000 !important; }
.badge.bg-d { background-color: var(--health-fair) !important; }
.badge.bg-e { background-color: var(--health-poor) !important; }

.interactive-card {
  cursor: pointer;
  transition: all var(--transition-normal);
}

.interactive-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.product-image img,
.product-image div {
  border: 1px solid var(--border-color);
}

/* Modal enhancements */
.modal-content {
  border-radius: var(--border-radius-lg);
}

.modal-header {
  background: var(--bg-secondary);
}

/* Form enhancements */
.input-group-text {
  background-color: var(--bg-secondary);
  border-color: var(--border-color);
  color: var(--text-muted);
}

.product-link {
  color: inherit;
  text-decoration: none;
}

.product-link:hover {
  text-decoration: underline;
}

@media (max-width: 768px) {
  .nutrition-goal-card {
    padding: 1rem;
  }
  
  .card-body {
    padding: 1.5rem !important;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

function resetDailyGoals() {
    if (confirm('Are you sure you want to reset today\'s nutrition tracking? This will set all consumed values to zero.')) {
        fetch('{% url "accounts:reset_daily_goals" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while resetting goals.');
        });
    }
}

function exportNutritionData() {
    const data = {
        user: '{{ user.username }}',
        goals: {
            calories: {{ dietary_goals.calories_target|default:0 }},
            protein: {{ dietary_goals.protein_target|default:0 }},
            fat: {{ dietary_goals.fat_target|default:0 }},
            carbs: {{ dietary_goals.carbs_target|default:0 }}
        },
        consumed: {
            calories: {{ dietary_goals.calories_consumed|default:0 }},
            protein: {{ dietary_goals.protein_consumed|default:0 }},
            fat: {{ dietary_goals.fat_consumed|default:0 }},
            carbs: {{ dietary_goals.carbs_consumed|default:0 }}
        },
        stats: {
            totalScans: {{ scan_history|length }},
            favorites: {{ favorite_products|length }},
            reviews: {{ user_reviews|length }},
            daysActive: {{ days_active }}
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nutrition-data-{{ user.username }}.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function updateProgressBars(data) {
    // Update progress bars with new values
    const nutrients = ['calories', 'protein', 'fat', 'carbs'];
    
    nutrients.forEach(nutrient => {
        const progress = data.progress[nutrient] || 0;
        const remaining = data.remaining[nutrient] || 0;
        const target = data.targets ? data.targets[nutrient] : 0;
        
        // Update progress bar width
        const progressBar = document.querySelector(`.nutrition-bar .progress-fill.bg-${nutrient === 'calories' ? 'primary' : nutrient === 'protein' ? 'info' : nutrient === 'fat' ? 'warning' : 'success'}`);
        if (progressBar) {
            progressBar.style.width = Math.min(progress, 100) + '%';
        }
        
        // Update badge with current/target values
        const badge = document.querySelector(`.badge:contains("${nutrient}")`);
        if (badge && target) {
            const consumed = target - remaining;
            const unit = nutrient === 'calories' ? '' : 'g';
            badge.textContent = `${consumed}/${target}${unit}`;
        }
        
        // Update percentage text
        const percentageText = document.querySelector(`.text-muted:contains("% of goal")`);
        if (percentageText) {
            percentageText.textContent = `${Math.round(progress)}% of goal`;
        }
        
        // Update remaining text
        const remainingText = document.querySelector(`.text-muted:contains("left")`);
        if (remainingText) {
            const unit = nutrient === 'calories' ? ' kcal' : 'g';
            remainingText.textContent = `${remaining}${unit} left`;
        }
    });
}

// Enhanced goal setting with preset options and AJAX form submission
document.addEventListener('DOMContentLoaded', function() {
    console.log('[v0] Dashboard JavaScript loaded');
    
    // Handle Quick Preset button clicks
    const presetButtons = document.querySelectorAll('.preset-goal-btn');
    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const preset = this.getAttribute('data-preset');
            console.log('[v0] Preset button clicked:', preset);
            
            // Remove active state from all preset buttons
            presetButtons.forEach(btn => btn.classList.remove('btn-primary', 'active'));
            presetButtons.forEach(btn => btn.classList.add('btn-outline-primary'));
            
            // Add active state to clicked button
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary', 'active');
            
            // Set preset values based on selection
            let presetValues = {};
            
            switch(preset) {
                case 'weight-loss':
                    presetValues = {
                        calories: 1500,
                        protein: 120,
                        fat: 50,
                        carbs: 150,
                        sugar: 25,
                        sodium: 2000,
                        fiber: 25
                    };
                    break;
                case 'maintenance':
                    presetValues = {
                        calories: 2000,
                        protein: 100,
                        fat: 65,
                        carbs: 250,
                        sugar: 50,
                        sodium: 2300,
                        fiber: 25
                    };
                    break;
                case 'muscle-gain':
                    presetValues = {
                        calories: 2500,
                        protein: 150,
                        fat: 85,
                        carbs: 300,
                        sugar: 60,
                        sodium: 2300,
                        fiber: 30
                    };
                    break;
            }
            
            // Update form fields with preset values
            Object.keys(presetValues).forEach(nutrient => {
                const input = document.getElementById(`id_${nutrient}_target`);
                if (input) {
                    input.value = presetValues[nutrient];
                    // Trigger input event to update any listeners
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            console.log('[v0] Applied preset values:', presetValues);
        });
    });
    
    // Single updateProgressBars function to avoid conflicts
    function updateProgressBars(data) {
        console.log('[v0] Updating progress bars with data:', data);
        
        if (data.progress) {
            const nutrients = ['calories', 'protein', 'fat', 'carbs', 'sugar', 'sodium'];
            
            nutrients.forEach(nutrient => {
                const progress = data.progress[nutrient] || 0;
                const card = document.querySelector(`[data-nutrient="${nutrient}"]`);
                
                if (card) {
                    const progressBar = card.querySelector('.progress-bar');
                    const progressText = card.querySelector('.progress-text');
                    const remainingElement = card.querySelector(`[data-remaining="${nutrient}"]`);
                    
                    if (progressBar) {
                        progressBar.style.width = Math.min(progress, 100) + '%';
                    }
                    
                    if (progressText) {
                        progressText.textContent = Math.round(progress) + '% of goal';
                    }
                    
                    if (remainingElement && data.remaining && data.remaining[nutrient] !== undefined) {
                        const unit = nutrient === 'calories' ? ' kcal' : 'g';
                        remainingElement.textContent = data.remaining[nutrient] + unit + ' left';
                    }
                }
            });
        }
    }

    // Enhanced goal setting form submission
    const goalForm = document.getElementById('nutritionGoalsForm');
    if (goalForm) {
        goalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.innerHTML : '';
            
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
            }
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('[v0] Response data:', data);
                if (data.success) {
                    // Update progress bars immediately
                    updateProgressBars(data);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nutritionGoalsModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Auto-remove alert after 5 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                    
                    // Reload page after short delay to show updated values
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    console.error('[v0] Server error:', data.error);
                    alert('Error: ' + (data.error || 'Failed to save goals'));
                }
            })
            .catch(error => {
                console.error('[v0] Fetch error:', error);
                alert('An error occurred while saving goals. Please try again.');
            })
            .finally(() => {
                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        });
    }
});
    // Manual nutrition form submission
    const manualForm = document.getElementById('manualNutritionForm');
    if (manualForm) {
        manualForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const calories = parseFloat(document.getElementById('manualCalories').value) || 0;
            const protein = parseFloat(document.getElementById('manualProtein').value) || 0;
            const fat = parseFloat(document.getElementById('manualFat').value) || 0;
            const carbs = parseFloat(document.getElementById('manualCarbs').value) || 0;
            
            if (calories === 0 && protein === 0 && fat === 0 && carbs === 0) {
                alert('Please enter at least one nutrition value.');
                return;
            }
            
            // Send AJAX request to add manual nutrition
            fetch('{% url "accounts:add_manual_nutrition" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    calories: calories,
                    protein: protein,
                    fat: fat,
                    carbs: carbs
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update progress bars without page reload
                    updateProgressBarsFromData(data.updated_goals);
                    
                    // Clear form
                    manualForm.reset();
                    
                    // Show success message
                    showSuccessMessage('Nutrition added successfully!');
                } else {
                    alert('Error adding nutrition: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding nutrition. Please try again.');
            });
        });
    }

    // Enhanced preset functionality with confirmation
    const presetButtons = document.querySelectorAll('.preset-goal-btn');
    const presetModal = new bootstrap.Modal(document.getElementById('presetConfirmModal'));
    let selectedPreset = null;
    
    const presetData = {
        'weight-loss': {
            name: 'Weight Loss',
            calories: 1500,
            protein: 120,
            fat: 50,
            carbs: 150,
            sugar: 25,
            sodium: 1800
        },
        'maintenance': {
            name: 'Maintenance',
            calories: 2000,
            protein: 100,
            fat: 67,
            carbs: 250,
            sugar: 50,
            sodium: 2000
        },
        'muscle-gain': {
            name: 'Muscle Gain',
            calories: 2500,
            protein: 150,
            fat: 83,
            carbs: 313,
            sugar: 60,
            sodium: 2200
        }
    };
    
    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const presetType = this.dataset.preset;
            selectedPreset = presetData[presetType];
            
            if (selectedPreset) {
                // Update modal content
                document.getElementById('presetTypeName').textContent = selectedPreset.name;
                document.getElementById('presetCalories').textContent = selectedPreset.calories;
                document.getElementById('presetProtein').textContent = selectedPreset.protein;
                document.getElementById('presetFat').textContent = selectedPreset.fat;
                document.getElementById('presetCarbs').textContent = selectedPreset.carbs;
                document.getElementById('presetSugar').textContent = selectedPreset.sugar;
                document.getElementById('presetSodium').textContent = selectedPreset.sodium;
                
                // Show confirmation modal
                presetModal.show();
            }
        });
    });
    
    // Confirm preset application
    document.getElementById('confirmPresetBtn').addEventListener('click', function() {
        if (selectedPreset) {
            // Fill form fields
            document.getElementById('id_calories_target').value = selectedPreset.calories;
            document.getElementById('id_protein_target').value = selectedPreset.protein;
            document.getElementById('id_fat_target').value = selectedPreset.fat;
            document.getElementById('id_carbs_target').value = selectedPreset.carbs;
            document.getElementById('id_sugar_target').value = selectedPreset.sugar;
            document.getElementById('id_sodium_target').value = selectedPreset.sodium;
            
            // Highlight active preset button
            presetButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-preset="${Object.keys(presetData).find(key => presetData[key] === selectedPreset)}"]`).classList.add('active');
            
            // Hide modal
            presetModal.hide();
            
            showSuccessMessage(`${selectedPreset.name} preset applied! Don't forget to save your goals.`);
        }
    });

    // Helper functions
    function updateProgressBarsFromData(goals) {
        // Update calories
        const caloriesProgress = (goals.calories_consumed / goals.calories_target) * 100;
        updateProgressBar('calories', caloriesProgress, goals.calories_consumed, goals.calories_target, 'kcal');
        
        // Update protein
        const proteinProgress = (goals.protein_consumed / goals.protein_target) * 100;
        updateProgressBar('protein', proteinProgress, goals.calories_consumed, goals.calories_target, 'g');
        
        // Update fat
        const fatProgress = (goals.fat_consumed / goals.fat_target) * 100;
        updateProgressBar('fat', fatProgress, goals.fat_consumed, goals.fat_target, 'g');
        
        // Update carbs
        const carbsProgress = (goals.carbs_consumed / goals.carbs_target) * 100;
        updateProgressBar('carbs', carbsProgress, goals.carbs_consumed, goals.carbs_target, 'g');
    }
    
    function updateProgressBar(nutrient, progress, consumed, target, unit) {
        const card = document.querySelector(`[data-nutrient="${nutrient}"]`);
        if (card) {
            const progressBar = card.querySelector('.progress-fill');
            const badge = card.querySelector('.badge');
            const progressText = card.querySelector('.progress-text');
            const remainingText = card.querySelector(`[data-remaining="${nutrient}"]`);
            
            if (progressBar) {
                progressBar.style.width = Math.min(progress, 100) + '%';
                
                // Update color based on progress
                let color;
                if (progress < 50) {
                    color = 'linear-gradient(90deg, #dc3545, #fd7e14)';
                } else if (progress <= 80) {
                    color = nutrient === 'calories' ? 'linear-gradient(90deg, #ffc107, #fd7e14)' :
                           nutrient === 'protein' ? 'linear-gradient(90deg, #0ea5e9, #06b6d4)' :
                           nutrient === 'fat' ? 'linear-gradient(90deg, #ffc107, #f59e0b)' :
                           'linear-gradient(90deg, #198754, #10b981)';
                } else {
                    color = 'linear-gradient(90deg, #198754, #20c997)';
                }
                progressBar.style.background = color;
            }
            
            if (badge) {
                badge.textContent = `${consumed}/${target}${unit === 'kcal' ? '' : unit}`;
            }
            
            if (progressText) {
                progressText.textContent = `${Math.round(progress)}% of goal`;
            }
            
            if (remainingText) {
                const remaining = Math.max(0, target - consumed);
                remainingText.textContent = `${remaining}${unit === 'kcal' ? ' kcal' : unit} left`;
            }
        }
    }
    
    function showSuccessMessage(message) {
        // Create and show a temporary success alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}
