{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Food Facts Scanner{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Modern Dashboard Header -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="mb-3 mb-md-0">
          <h1 class="display-5 fw-bold mb-2" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-speedometer2 me-3 text-primary"></i>Dashboard
          </h1>
          <p class="text-muted fs-5 mb-0">Welcome back, <strong>{{ user.get_full_name|default:user.username }}</strong>!</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
            <i class="bi bi-gear me-1"></i>Set Goals
          </button>
          <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
            <i class="bi bi-camera me-1"></i>Scan Product
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Stats Cards -->
  <div class="row mb-5">
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 p-3 mb-3">
            <i class="bi bi-upc-scan fs-2 text-primary"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ scan_history|length }}</h3>
          <p class="text-muted mb-0">Products Scanned</p>
          <small class="text-success">
            <i class="bi bi-arrow-up"></i> +{{ recent_scans_count }} this week
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-danger bg-opacity-10 p-3 mb-3">
            <i class="bi bi-heart-fill fs-2 text-danger"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ favorite_products|length }}</h3>
          <p class="text-muted mb-0">Favorite Products</p>
          <small class="text-info">
            <i class="bi bi-star"></i> Top rated items
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10 p-3 mb-3">
            <i class="bi bi-star-fill fs-2 text-warning"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ user_reviews|length }}</h3>
          <p class="text-muted mb-0">Reviews Written</p>
          <small class="text-warning">
            <i class="bi bi-chat"></i> Community contributor
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 interactive-card">
        <div class="card-body text-center p-4">
          <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 p-3 mb-3">
            <i class="bi bi-calendar-check fs-2 text-success"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ days_active }}</h3>
          <p class="text-muted mb-0">Days Active</p>
          <small class="text-success">
            <i class="bi bi-trophy"></i> Keep it up!
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Nutrition Goals Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="fw-bold mb-1" style="font-family: 'Manrope', sans-serif;">
                <i class="bi bi-bullseye me-2 text-primary"></i>Daily Nutrition Goals
              </h4>
              <p class="text-muted mb-0">Track your daily nutrition intake and goals</p>
            </div>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
              <i class="bi bi-gear me-1"></i>Adjust Goals
            </button>
          </div>
        </div>
        <div class="card-body p-4">
          {% if dietary_goals %}
          <div class="row">
            <!-- Enhanced progress bars with completion-based colors and tooltips -->
            <!-- Calories -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="calories">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-primary">
                    <i class="bi bi-fire me-1"></i>Calories
                  </span>
                  <span class="badge bg-primary bg-opacity-10 text-primary" 
                        data-bs-toggle="tooltip" 
                        title="{% if calories_progress < 50 %}Low intake - consider adding healthy snacks{% elif calories_progress > 100 %}Over target - monitor portion sizes{% else %}Good progress towards your goal{% endif %}">
                    {{ dietary_goals.calories_consumed }}/{{ dietary_goals.calories_target }}
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if calories_progress == 0 %}No data logged yet - start by scanning products or adding manual entries{% else %}{{ calories_progress|floatformat:1 }}% of daily goal completed{% endif %}">
                  <div class="progress-fill progress-bar calories-progress" 
                       style="width: {{ calories_progress|floatformat:1 }}%; 
                              background: {% if calories_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif calories_progress <= 80 %}linear-gradient(90deg, #ffc107, #fd7e14){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ calories_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="calories">{{ calories_remaining }} kcal left</small>
                </div>
              </div>
            </div>
            
            <!-- Protein -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="protein">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-info">
                    <i class="bi bi-egg me-1"></i>Protein
                  </span>
                  <span class="badge bg-info bg-opacity-10 text-info"
                        data-bs-toggle="tooltip" 
                        title="{% if protein_progress < 50 %}Low protein - add lean meats, beans, or nuts{% elif protein_progress > 100 %}Excellent protein intake{% else %}Good protein progress{% endif %}">
                    {{ dietary_goals.protein_consumed }}/{{ dietary_goals.protein_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if protein_progress == 0 %}No protein logged yet{% else %}{{ protein_progress|floatformat:1 }}% of protein goal completed{% endif %}">
                  <div class="progress-fill progress-bar protein-progress" 
                       style="width: {{ protein_progress|floatformat:1 }}%; 
                              background: {% if protein_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif protein_progress <= 80 %}linear-gradient(90deg, #0ea5e9, #06b6d4){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ protein_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="protein">{{ protein_remaining }}g left</small>
                </div>
              </div>
            </div>
            
            <!-- Fat -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="fat">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-warning">
                    <i class="bi bi-droplet me-1"></i>Fat
                  </span>
                  <span class="badge bg-warning bg-opacity-10 text-warning"
                        data-bs-toggle="tooltip" 
                        title="{% if fat_progress < 50 %}Low fat intake - add healthy fats like avocado or nuts{% elif fat_progress > 100 %}High fat intake - monitor portions{% else %}Balanced fat intake{% endif %}">
                    {{ dietary_goals.fat_consumed }}/{{ dietary_goals.fat_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if fat_progress == 0 %}No fat logged yet{% else %}{{ fat_progress|floatformat:1 }}% of fat goal completed{% endif %}">
                  <div class="progress-fill progress-bar fat-progress" 
                       style="width: {{ fat_progress|floatformat:1 }}%; 
                              background: {% if fat_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif fat_progress <= 80 %}linear-gradient(90deg, #ffc107, #f59e0b){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ fat_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="fat">{{ fat_remaining }}g left</small>
                </div>
              </div>
            </div>
            
            <!-- Carbs -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="nutrition-goal-card" data-nutrient="carbs">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold text-success">
                    <i class="bi bi-grain me-1"></i>Carbs
                  </span>
                  <span class="badge bg-success bg-opacity-10 text-success"
                        data-bs-toggle="tooltip" 
                        title="{% if carbs_progress < 50 %}Low carb intake - add whole grains or fruits{% elif carbs_progress > 100 %}High carb intake - focus on complex carbs{% else %}Good carb balance{% endif %}">
                    {{ dietary_goals.carbs_consumed }}/{{ dietary_goals.carbs_target }}g
                  </span>
                </div>
                <div class="nutrition-bar mb-2" data-bs-toggle="tooltip" 
                     title="{% if carbs_progress == 0 %}No carbs logged yet{% else %}{{ carbs_progress|floatformat:1 }}% of carb goal completed{% endif %}">
                  <div class="progress-fill progress-bar carbs-progress" 
                       style="width: {{ carbs_progress|floatformat:1 }}%; 
                              background: {% if carbs_progress < 50 %}linear-gradient(90deg, #dc3545, #fd7e14){% elif carbs_progress <= 80 %}linear-gradient(90deg, #198754, #10b981){% else %}linear-gradient(90deg, #198754, #20c997){% endif %}; 
                              transition: width 0.8s ease-in-out;">
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted progress-text">{{ carbs_progress|floatformat:0 }}% of goal</small>
                  <small class="text-muted" data-remaining="carbs">{{ carbs_remaining }}g left</small>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Added enhanced analytics and achievement tracking -->
          <div class="row mt-4">
            <div class="col-md-6 mb-4">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="fw-semibold mb-3">
                    <i class="bi bi-graph-up me-2 text-success"></i>Weekly Progress
                  </h6>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Scans this week</span>
                    <span class="fw-semibold text-success">{{ recent_scans_count }}</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Goal completion</span>
                    <span class="fw-semibold text-primary">
                      {% widthratio calories_progress 100 100 %}%
                    </span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">Streak</span>
                    <span class="fw-semibold text-warning">{{ days_active }} days</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-4">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="fw-semibold mb-3">
                    <i class="bi bi-trophy me-2 text-warning"></i>Achievements
                  </h6>
                  {% if scan_history|length >= 10 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Scanner Pro (10+ scans)</span>
                  </div>
                  {% endif %}
                  {% if user_reviews|length >= 5 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Reviewer (5+ reviews)</span>
                  </div>
                  {% endif %}
                  {% if favorite_products|length >= 3 %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Curator (3+ favorites)</span>
                  </div>
                  {% endif %}
                  {% if days_active >= 7 %}
                  <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="small">Consistent User (7+ days)</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Manual Nutrition Input Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card border-0 bg-light">
                <div class="card-header bg-transparent border-0 p-3">
                  <h6 class="fw-bold mb-0">
                    <i class="bi bi-plus-circle me-2 text-primary"></i>Add Manual Entry
                  </h6>
                </div>
                <div class="card-body p-3">
                  <form id="manualNutritionForm" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-3">
                      <label class="form-label small">Calories</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualCalories" placeholder="0" min="0" max="5000">
                        <span class="input-group-text">kcal</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Protein</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualProtein" placeholder="0" min="0" max="200">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Fat</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualFat" placeholder="0" min="0" max="200">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Carbs</label>
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="manualCarbs" placeholder="0" min="0" max="300">
                        <span class="input-group-text">g</span>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small">&nbsp;</label>
                      <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-plus me-1"></i>Add to Today
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-primary" id="resetBtn">
                  <i class="bi bi-arrow-clockwise me-1"></i>Reset Today
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="resetManualFormBtn">
                  <i class="bi bi-x-circle me-1"></i>Clear Form
                </button>
                <a href="{% url 'scanner:scan' %}" class="btn btn-sm btn-primary">
                  <i class="bi bi-plus-circle me-1"></i>Add Food
                </a>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#nutritionTipsModal">
                  <i class="bi bi-lightbulb me-1"></i>Tips
                </button>
                <!-- Added export functionality for user data -->
                <button class="btn btn-sm btn-outline-info" onclick="exportNutritionData()">
                  <i class="bi bi-download me-1"></i>Export Data
                </button>
              </div>
            </div>
          </div>
          {% else %}
          <!-- No goals set yet -->
          <div class="text-center py-5">
            <i class="bi bi-bullseye display-1 text-muted mb-3"></i>
            <h5 class="fw-semibold mb-3">Set Your Nutrition Goals</h5>
            <p class="text-muted mb-4">Start tracking your daily nutrition by setting personalized goals</p>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#nutritionGoalsModal">
              <i class="bi bi-plus-circle me-2"></i>Set My Goals
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Added comprehensive Recent Activity section with enhanced scan logging -->
  <div class="row mb-5">
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">
              <i class="bi bi-clock-history me-2 text-primary"></i>Recent Activity
            </h5>
            <a href="{% url 'scanner:history' %}" class="btn btn-sm btn-outline-primary">
              View All History
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          {% if scan_history %}
          <div class="list-group list-group-flush">
            {% for scan in scan_history %}
            <div class="list-group-item border-0 py-3 px-4">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  {% if scan.product.image_url %}
                  <img src="{{ scan.product.image_url }}" alt="{{ scan.product.name }}" 
                       class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                  {% else %}
                  <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                       style="width: 50px; height: 50px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                  {% endif %}
                </div>
                <div class="flex-grow-1">
                  {% if scan.product.barcode %}
                  <a href="{% url 'scanner:product_detail' scan.product.barcode %}" 
                     class="text-decoration-none product-link" style="padding-top: 80px;">
                    <h6 class="mb-1 fw-semibold">{{ scan.product.name|truncatechars:40 }}</h6>
                  </a>
                  {% else %}
                  <h6 class="mb-1 fw-semibold text-muted">{{ scan.product.name|truncatechars:40 }}</h6>
                  {% endif %}
                  <div class="d-flex align-items-center gap-3">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>{{ scan.scanned_at|timesince }} ago
                    </small>
                    {% if scan.product.brand %}
                    <small class="text-muted">
                      <i class="bi bi-building me-1"></i>{{ scan.product.brand }}
                    </small>
                    {% endif %}
                    {% if scan.product.health_score %}
                    <span class="badge badge-sm 
                      {% if scan.product.health_score >= 80 %}bg-success
                      {% elif scan.product.health_score >= 60 %}bg-warning
                      {% else %}bg-danger{% endif %}">
                      Health: {{ scan.product.health_score }}/100
                    </span>
                    {% endif %}
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <i class="bi bi-chevron-right text-muted"></i>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-upc-scan display-1 text-muted mb-3"></i>
            <h6 class="fw-semibold mb-2">No Scans Yet</h6>
            <p class="text-muted mb-4">Start scanning products to see your activity here</p>
            <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
              <i class="bi bi-camera me-2"></i>Scan Your First Product
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Added Quick Stats sidebar with personalized insights -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 p-4">
          <h6 class="fw-bold mb-0">
            <i class="bi bi-pie-chart me-2 text-primary"></i>Quick Stats
          </h6>
        </div>
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Total Products</span>
            <span class="fw-bold">{{ scan_history|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Favorites</span>
            <span class="fw-bold text-danger">{{ favorite_products|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Reviews</span>
            <span class="fw-bold text-warning">{{ user_reviews|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Member Since</span>
            <span class="fw-bold text-success">{{ user.date_joined|date:"M Y" }}</span>
          </div>
        </div>
      </div>

      <!-- Fixed personalized tips to always show content and not disappear -->
      <!-- Enhanced personalized tips section to be always visible and dynamic -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4 d-flex justify-content-between align-items-center">
          <h6 class="fw-bold mb-0">
            <i class="bi bi-lightbulb me-2 text-warning"></i>Personalized Tips
          </h6>
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshPersonalizedTips()" title="Refresh Tips">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
        <div class="card-body p-4" id="personalizedTipsContent">
          {% for tip in personalized_tips %}
          <div class="alert alert-{{ tip.color }} alert-sm mb-3 tip-item" data-tip-type="{{ tip.type }}" data-priority="{{ tip.priority }}">
            <div class="d-flex align-items-start">
              <i class="bi bi-{{ tip.icon }} me-2 flex-shrink-0 mt-1"></i>
              <div>
                <strong>{{ tip.title }}</strong><br>
                <small>{{ tip.message }}</small>
                <!-- Added timestamp for tip persistence tracking -->
                {% if tip.updated_at %}
                <div class="text-muted mt-1" style="font-size: 0.75rem;">
                  <i class="bi bi-clock me-1"></i>Updated {{ tip.updated_at|timesince }} ago
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="alert alert-info alert-sm mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <small>Keep tracking your nutrition to get personalized tips!</small>
          </div>
          {% endfor %}
          
          <!-- Added visual indicator for tip persistence -->
          <div class="text-center mt-3">
            <small class="text-muted">
              <i class="bi bi-shield-check me-1"></i>
              Tips remain visible until your nutrition data changes significantly
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Sections -->
  <div class="row">
    <!-- Scan History (moved from navbar) -->
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
              <i class="bi bi-clock-history me-2 text-primary"></i>Recent Scans
            </h5>
            <a href="{% url 'scanner:history' %}" class="btn btn-sm btn-outline-primary">
              View All History
            </a>
          </div>
        </div>
        <div class="card-body p-4">
          {% if scan_history %}
            {% for scan in scan_history %}
            <div class="d-flex align-items-center mb-3 p-3 rounded-3 bg-light bg-opacity-50 {% if not forloop.last %}mb-3{% endif %}">
              <div class="product-image me-3">
                {% if scan.product.image_url %}
                <img
                  src="{{ scan.product.image_url }}"
                  alt="{{ scan.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-semibold">
                  <!-- <CHANGE> Fixed dark theme text contrast by replacing text-dark with theme-aware class -->
                  <a href="{% url 'scanner:product_detail' scan.product.barcode %}" class="text-decoration-none text-primary-custom">
                    {{ scan.product.name|truncatechars:35 }}
                  </a>
                </h6>
                <div class="d-flex align-items-center gap-2 mb-1">
                  {% if scan.product.health_score %}
                  <span class="badge bg-{{ scan.product.health_score|lower }} badge-sm">
                    {{ scan.product.health_score }}
                  </span>
                  {% endif %}
                  <small class="text-muted">{{ scan.product.brand|default:"Unknown Brand" }}</small>
                </div>
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>{{ scan.scanned_at|timesince }} ago
                </small>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-upc-scan display-1 text-muted mb-3"></i>
              <h6 class="fw-semibold mb-2">No scans yet</h6>
              <p class="text-muted mb-3">Start scanning products to see your history here</p>
              <a href="{% url 'scanner:scan' %}" class="btn btn-primary">
                <i class="bi bi-camera me-1"></i>Start Scanning
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Favorite Products -->
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 p-4">
          <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-heart-fill me-2 text-danger"></i>Favorite Products
          </h5>
        </div>
        <div class="card-body p-4">
          {% if favorite_products %}
            {% for favorite in favorite_products %}
            <div class="d-flex align-items-center mb-3 p-3 rounded-3 bg-light bg-opacity-50">
              <div class="product-image me-3">
                {% if favorite.product.image_url %}
                <img
                  src="{{ favorite.product.image_url }}"
                  alt="{{ favorite.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-semibold">
                  <a href="{% url 'scanner:product_detail' favorite.product.barcode %}" class="text-decoration-none text-dark product-link" style="padding-top: 20px; display: inline-block;">
                    {{ favorite.product.name|truncatechars:35 }}
                  </a>
                </h6>
                <div class="d-flex align-items-center gap-2 mb-1">
                  {% if favorite.product.health_score %}
                  <span class="badge bg-{{ favorite.product.health_score|lower }} badge-sm">
                    {{ favorite.product.health_score }}
                  </span>
                  {% endif %}
                  <small class="text-muted">{{ favorite.product.brand|default:"Unknown Brand" }}</small>
                </div>
                <small class="text-muted">
                  <i class="bi bi-heart me-1"></i>Added {{ favorite.added_at|timesince }} ago
                </small>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-heart display-1 text-muted mb-3"></i>
              <h6 class="fw-semibold mb-2">No favorites yet</h6>
              <p class="text-muted mb-3">Add products to your favorites to see them here</p>
              <a href="{% url 'scanner:search' %}" class="btn btn-outline-primary">
                <i class="bi bi-search me-1"></i>Browse Products
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Added Tracked Items panel for nutrition tracker visibility -->
  <!-- Tracked Items Panel -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
              <i class="bi bi-clipboard-check me-2 text-success"></i>Tracked Items
            </h5>
            <span class="badge bg-primary">{{ tracked_items|length }} item{{ tracked_items|length|pluralize }}</span>
          </div>
        </div>
        <div class="card-body p-4">
          {% if tracked_items %}
            <div class="row g-3">
              {% for item in tracked_items %}
              <div class="col-md-6 col-lg-4">
                <div class="tracked-item-card p-3 rounded-3 border bg-light bg-opacity-50 h-100">
                  <div class="d-flex align-items-start mb-2">
                    <div class="product-image me-3">
                      {% if item.product.image_url %}
                      <img
                        src="{{ item.product.image_url }}"
                        alt="{{ item.product.name }}"
                        class="rounded-3"
                        width="50"
                        height="50"
                        style="object-fit: cover"
                      />
                      {% else %}
                      <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 50px; height: 50px">
                        <i class="bi bi-image text-muted"></i>
                      </div>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1 fw-semibold">
                        <a href="{% url 'scanner:product_detail' item.product.barcode %}" class="text-decoration-none text-dark">
                          {{ item.product.name|truncatechars:25 }}
                        </a>
                      </h6>
                      <div class="d-flex align-items-center gap-2 mb-1">
                        {% if item.product.health_score %}
                        <span class="badge bg-{% if item.product.health_score >= 70 %}success{% elif item.product.health_score >= 40 %}warning{% else %}danger{% endif %} badge-sm">
                          {{ item.product.health_score }}
                        </span>
                        {% endif %}
                        {% if item.product.nova_group %}
                        <span class="badge bg-{% if item.product.nova_group == 1 %}success{% elif item.product.nova_group == 2 %}info{% elif item.product.nova_group == 3 %}warning{% else %}danger{% endif %} badge-sm">
                          NOVA {{ item.product.nova_group }}
                        </span>
                        {% endif %}
                      </div>
                      <small class="text-muted">{{ item.serving_size }}g serving</small>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>{{ item.added_at|timesince }} ago
                    </small>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeTrackedItem({{ item.id }})" title="Remove from tracker">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-clipboard-check display-1 text-muted mb-3"></i>
              <h6 class="fw-semibold mb-2">No tracked items yet</h6>
              <p class="text-muted mb-3">Add products to your nutrition tracker to see them here</p>
              <a href="{% url 'scanner:search' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Start Tracking
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Reviews -->
  {% if user_reviews %}
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 p-4">
          <h5 class="fw-bold mb-0" style="font-family: 'Manrope', sans-serif;">
            <i class="bi bi-star-fill me-2 text-warning"></i>Your Recent Reviews
          </h5>
        </div>
        <div class="card-body p-4">
          {% for review in user_reviews %}
          <div class="mb-4 p-3 rounded-3 bg-light bg-opacity-50 {% if not forloop.last %}mb-4{% endif %}">
            <div class="d-flex align-items-start">
              <div class="product-image me-3">
                {% if review.product.image_url %}
                <img
                  src="{{ review.product.image_url }}"
                  alt="{{ review.product.name }}"
                  class="rounded-3"
                  width="60"
                  height="60"
                  style="object-fit: cover"
                />
                {% else %}
                <div class="bg-white rounded-3 d-flex align-items-center justify-content-center border" style="width: 60px; height: 60px">
                  <i class="bi bi-image text-muted fs-4"></i>
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-2 fw-semibold">
                  <a href="{% url 'scanner:product_detail' review.product.barcode %}" class="text-decoration-none text-dark product-link" style="padding-top: 20px; display: inline-block;">
                    {{ review.product.name }}
                  </a>
                </h6>
                <div class="mb-2">
                  {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}
                      <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-muted"></i>
                    {% endif %}
                  {% endfor %}
                  <small class="text-muted ms-2">{{ review.created_at|date:"M d, Y" }}</small>
                </div>
                {% if review.review_text %}
                <p class="mb-0 text-muted">{{ review.review_text|truncatechars:120 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Enhanced nutrition goals modal with sugar and sodium tracking -->
<div class="modal fade" id="nutritionGoalsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold" style="font-family: 'Manrope', sans-serif;">
          <i class="bi bi-bullseye me-2 text-primary"></i>Set Nutrition Goals
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="nutritionGoalsForm" method="post" action="{% url 'accounts:update_nutrition_goals' %}">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Calories Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="calories_target" id="calories_target"
                       value="{{ dietary_goals.calories_target|default:2000 }}" min="1000" max="5000">
                <span class="input-group-text">kcal</span>
              </div>
              <small class="form-text text-muted">Recommended: 1800-2500 kcal/day</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Protein Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="protein_target" id="protein_target"
                       value="{{ dietary_goals.protein_target|default:50 }}" min="20" max="200">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 0.8-1.2g per kg body weight</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Fat Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="fat_target" id="fat_target"
                       value="{{ dietary_goals.fat_target|default:70 }}" min="20" max="150">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 20-35% of total calories</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Carbs Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="carbs_target" id="carbs_target"
                       value="{{ dietary_goals.carbs_target|default:300 }}" min="50" max="500">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">Recommended: 45-65% of total calories</small>
            </div>
            <!-- Added sugar and sodium target inputs -->
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Sugar Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="sugar_target" id="sugar_target"
                       value="{{ dietary_goals.sugar_target|default:50 }}" min="10" max="200">
                <span class="input-group-text">g</span>
              </div>
              <small class="form-text text-muted">WHO recommends: <25g/day</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Daily Sodium Target</label>
              <div class="input-group">
                <input type="number" class="form-control" name="sodium_target" id="sodium_target"
                       value="{{ dietary_goals.sodium_target|default:2300 }}" min="500" max="5000">
                <span class="input-group-text">mg</span>
              </div>
              <small class="form-text text-muted">WHO recommends: <2000mg/day</small>
            </div>
          </div>
          
          <!-- Enhanced Quick Presets with confirmation modal -->
          <!-- Quick Presets -->
          <div class="mt-4">
            <h6 class="fw-semibold mb-3">Quick Presets</h6>
            <div class="row">
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="weight-loss">
                  <i class="bi bi-arrow-down-circle me-1"></i>Weight Loss
                </button>
              </div>
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="maintenance">
                  <i class="bi bi-dash-circle me-1"></i>Maintenance
                </button>
              </div>
              <div class="col-md-4 mb-2">
                <button type="button" class="btn btn-outline-primary w-100 preset-goal-btn" data-preset="muscle-gain">
                  <i class="bi bi-arrow-up-circle me-1"></i>Muscle Gain
                </button>
              </div>
            </div>
            <small class="text-muted">Click a preset to automatically fill in recommended values</small>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="nutritionGoalsForm" class="btn btn-primary" id="saveGoalsBtn">
          <i class="bi bi-check-circle me-1"></i>Save Goals
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Nutrition Tips Modal -->
<div class="modal fade" id="nutritionTipsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-lightbulb me-2 text-warning"></i>Nutrition Tips
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Stay Hydrated</h6>
            <p class="text-muted mb-0">Drink at least 8 glasses of water daily for optimal health.</p>
          </div>
        </div>
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Balanced Meals</h6>
            <p class="text-muted mb-0">Include protein, healthy fats, and complex carbs in each meal.</p>
          </div>
        </div>
        <div class="d-flex align-items-start mb-3">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Portion Control</h6>
            <p class="text-muted mb-0">Use smaller plates and listen to your hunger cues.</p>
          </div>
        </div>
        <div class="d-flex align-items-start">
          <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
          <div>
            <h6 class="fw-semibold">Regular Meals</h6>
            <p class="text-muted mb-0">Eat at consistent times to maintain stable energy levels.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Adding missing preset confirmation modal -->
<!-- Preset Confirmation Modal -->
<div class="modal fade" id="presetConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 p-4">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-question-circle me-2 text-warning"></i>Apply Preset Goals?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="mb-3">Are you sure you want to apply the <strong id="presetTypeName"></strong> preset?</p>
        <p class="text-muted mb-3">This will replace your current goal values.</p>
        
        <div class="bg-light p-3 rounded">
          <h6 class="fw-semibold mb-2">New Goals:</h6>
          <div class="row text-sm">
            <div class="col-6">
              <div class="mb-1">Calories: <span id="presetCalories">2000</span> kcal</div>
              <div class="mb-1">Protein: <span id="presetProtein">100</span>g</div>
              <div class="mb-1">Fat: <span id="presetFat">70</span>g</div>
            </div>
            <div class="col-6">
              <div class="mb-1">Carbs: <span id="presetCarbs">250</span>g</div>
              <div class="mb-1">Sugar: <span id="presetSugar">50</span>g</div>
              <div class="mb-1">Sodium: <span id="presetSodium">2300</span>mg</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmPresetBtn">
